import{r as u,j as r,m as N,q as d}from"./index-BzSc1h44.js";import{A as S}from"./index-Bheo6DJA.js";let C=!1;const b=typeof import.meta<"u"&&!1||typeof process<"u"&&!1;function A({trackId:a,roomId:f="global",maxVisible:h=5,scrollSpeed:c=5e3}){const g=typeof window<"u"&&window.location.hostname.endsWith("github.io")||!a&&C,[y,l]=u.useState([]),[_,j]=u.useState([]);return u.useEffect(()=>{if(g)return;let e=null;return(async()=>{var p;let m=!1;try{const n=a?d.from("track_comments").select("id, content, profiles(full_name), created_at").eq("track_id",a).order("created_at",{ascending:!1}).limit(20):d.from("chat_messages").select("id, message, profiles(full_name), created_at").eq("room_id",f).order("created_at",{ascending:!1}).limit(20),{data:o,error:t}=await n;if(t&&((t==null?void 0:t.code)==="PGRST205"||(p=t==null?void 0:t.message)!=null&&p.includes("Could not find the table 'public.chat_messages'")?(b||console.warn("[ScrollingComments] chat_messages table missing; disabling global comments"),C=!0):b||console.warn("[ScrollingComments] skipping due to schema error",t),l([]),m=!0),o){const w=o.map(i=>{var v;return{id:i.id,content:i.content??i.message??"",author:((v=i.profiles)==null?void 0:v.full_name)||"Anonymous",created_at:i.created_at}});l(w.reverse())}}catch(n){b||console.error("Failed to load scrolling comments:",n),l([]),m=!0}if(m)return;const x=a?"track_comments":"chat_messages";e=d.channel(`scrolling-comments-${a||f}`).on("postgres_changes",{event:"INSERT",schema:"public",table:x,filter:a?`track_id=eq.${a}`:`room_id=eq.${f}`},async n=>{try{const{data:o,error:t}=await d.from("profiles").select("full_name").eq("id",n.new.user_id).single();if(t)throw t;const w={id:n.new.id,content:n.new.content??n.new.message??"",author:(o==null?void 0:o.full_name)||"Anonymous",created_at:n.new.created_at};l(i=>[...i,w])}catch(o){b||console.error("Failed to hydrate scrolling comment:",o)}}).subscribe()})(),()=>{e&&d.removeChannel(e)}},[a,f]),u.useEffect(()=>{if(g||y.length===0||h<=0||c<=0)return;const e=setInterval(()=>{l(s=>{if(s.length===0)return s;const[m,...x]=s;return j(p=>[...p,m].slice(-h)),x})},c/h);return()=>clearInterval(e)},[y.length,h,c]),u.useEffect(()=>{if(g||_.length===0)return;const e=setTimeout(()=>{j(s=>s.slice(1))},c);return()=>clearTimeout(e)},[_,c]),g?null:r.jsx("div",{className:"fixed bottom-24 left-0 right-0 z-40 pointer-events-none px-4 md:px-8",children:r.jsx("div",{className:"mx-auto max-w-2xl",children:r.jsx(S,{mode:"popLayout",children:_.map((e,s)=>r.jsx(N.div,{initial:{y:50,opacity:0},animate:{y:0,opacity:1-s*.15},exit:{y:-50,opacity:0},transition:{duration:.5,ease:"easeOut"},className:"mb-2",style:{filter:`blur(${s*.5}px)`},children:r.jsx("div",{className:"inline-block rounded-full bg-background/60 backdrop-blur-xl border border-border/30 px-4 py-2 shadow-lg",children:r.jsxs("p",{className:"text-sm text-foreground",children:[r.jsxs("span",{className:"font-semibold",children:[e.author,":"]})," ",r.jsx("span",{className:"font-normal",children:e.content})]})})},e.id))})})})}export{A as ScrollingComments};
