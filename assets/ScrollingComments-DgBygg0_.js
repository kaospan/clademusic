import{r as u,j as r,m as C,q as d}from"./index-DgY7wBl0.js";import{A as N}from"./index-ClzCc4c2.js";let v=!1;function A({trackId:a,roomId:f="global",maxVisible:h=5,scrollSpeed:c=5e3}){const g=typeof window<"u"&&window.location.hostname.endsWith("github.io")||!a&&v,[w,l]=u.useState([]),[p,y]=u.useState([]);return u.useEffect(()=>{if(g)return;let e=null;return(async()=>{var b;let m=!1;try{const n=a?d.from("track_comments").select("id, content, profiles(full_name), created_at").eq("track_id",a).order("created_at",{ascending:!1}).limit(20):d.from("chat_messages").select("id, message, profiles(full_name), created_at").eq("room_id",f).order("created_at",{ascending:!1}).limit(20),{data:o,error:t}=await n;if(t&&((t==null?void 0:t.code)==="PGRST205"||(b=t==null?void 0:t.message)!=null&&b.includes("Could not find the table 'public.chat_messages'")?(console.warn("[ScrollingComments] chat_messages table missing; disabling global comments"),v=!0):console.warn("[ScrollingComments] skipping due to schema error",t),l([]),m=!0),o){const x=o.map(i=>{var j;return{id:i.id,content:i.content??i.message??"",author:((j=i.profiles)==null?void 0:j.full_name)||"Anonymous",created_at:i.created_at}});l(x.reverse())}}catch(n){console.error("Failed to load scrolling comments:",n),l([]),m=!0}if(m)return;const _=a?"track_comments":"chat_messages";e=d.channel(`scrolling-comments-${a||f}`).on("postgres_changes",{event:"INSERT",schema:"public",table:_,filter:a?`track_id=eq.${a}`:`room_id=eq.${f}`},async n=>{try{const{data:o,error:t}=await d.from("profiles").select("full_name").eq("id",n.new.user_id).single();if(t)throw t;const x={id:n.new.id,content:n.new.content??n.new.message??"",author:(o==null?void 0:o.full_name)||"Anonymous",created_at:n.new.created_at};l(i=>[...i,x])}catch(o){console.error("Failed to hydrate scrolling comment:",o)}}).subscribe()})(),()=>{e&&d.removeChannel(e)}},[a,f]),u.useEffect(()=>{if(g||w.length===0||h<=0||c<=0)return;const e=setInterval(()=>{l(s=>{if(s.length===0)return s;const[m,..._]=s;return y(b=>[...b,m].slice(-h)),_})},c/h);return()=>clearInterval(e)},[w.length,h,c]),u.useEffect(()=>{if(g||p.length===0)return;const e=setTimeout(()=>{y(s=>s.slice(1))},c);return()=>clearTimeout(e)},[p,c]),g?null:r.jsx("div",{className:"fixed bottom-24 left-0 right-0 z-40 pointer-events-none px-4 md:px-8",children:r.jsx("div",{className:"mx-auto max-w-2xl",children:r.jsx(N,{mode:"popLayout",children:p.map((e,s)=>r.jsx(C.div,{initial:{y:50,opacity:0},animate:{y:0,opacity:1-s*.15},exit:{y:-50,opacity:0},transition:{duration:.5,ease:"easeOut"},className:"mb-2",style:{filter:`blur(${s*.5}px)`},children:r.jsx("div",{className:"inline-block rounded-full bg-background/60 backdrop-blur-xl border border-border/30 px-4 py-2 shadow-lg",children:r.jsxs("p",{className:"text-sm text-foreground",children:[r.jsxs("span",{className:"font-semibold",children:[e.author,":"]})," ",r.jsx("span",{className:"font-normal",children:e.content})]})})},e.id))})})})}export{A as ScrollingComments};
