import{l as m,a as l,k as p,p as y,q as g}from"./index-D_N2VlPy.js";const L="https://ws.audioscrobbler.com/2.0";function F(){return"35ed8783bc2fca78c9b0dd99d8dcb9ef"}async function i(t,e){try{const r=F(),n=new URLSearchParams({method:t,api_key:r,format:"json",...e}),a=await fetch(`${L}?${n}`);if(!a.ok)return console.error(`Last.fm API error: ${a.status}`),null;const o=await a.json();return o.error?(console.error(`Last.fm error ${o.error}: ${o.message}`),null):o}catch(r){return console.error("Last.fm request failed:",r),null}}async function w(t){const e=await i("user.getInfo",{user:t});return(e==null?void 0:e.user)??null}async function _(t,e="3month",r=10){var a;const n=await i("user.getTopArtists",{user:t,period:e,limit:r.toString()});return((a=n==null?void 0:n.topartists)==null?void 0:a.artist)??[]}async function v(t,e="3month",r=10){var a;const n=await i("user.getTopTracks",{user:t,period:e,limit:r.toString()});return((a=n==null?void 0:n.toptracks)==null?void 0:a.track)??[]}async function b(t,e=20){var n;const r=await i("user.getRecentTracks",{user:t,limit:e.toString()});return((n=r==null?void 0:r.recenttracks)==null?void 0:n.track)??[]}async function q(t){var r,n;const e=await i("user.getWeeklyArtistChart",{user:t});return((n=(r=e==null?void 0:e.weeklyartistchart)==null?void 0:r.artist)==null?void 0:n.length)??0}async function I(t){if(!t)return null;try{const[e,r,n,a,o]=await Promise.all([w(t),_(t,"3month",10),v(t,"3month",10),b(t,10),q(t)]);if(!e)return null;const f=s=>{var d;if(!s||s.length===0)return;const u=["extralarge","large","medium","small"];for(const h of u){const c=s.find(k=>k.size===h);if(c!=null&&c["#text"])return c["#text"]}return((d=s[0])==null?void 0:d["#text"])||void 0};return{totalScrobbles:parseInt(e.playcount,10)||0,artistCount:parseInt(e.artist_count,10)||0,trackCount:parseInt(e.track_count,10)||0,registeredDate:new Date(parseInt(e.registered.unixtime,10)*1e3),topArtists:r.map(s=>({name:s.name,playcount:parseInt(s.playcount,10)||0,imageUrl:f(s.image)})),topTracks:n.map(s=>({name:s.name,artist:s.artist.name,playcount:parseInt(s.playcount||"0",10)})),recentTracks:a.map(s=>{var u;return{name:s.name,artist:s.artist.name,album:(u=s.album)==null?void 0:u["#text"],playedAt:s.date?new Date(parseInt(s.date.uts,10)*1e3):void 0,imageUrl:f(s.image),nowPlaying:!s.date}}),weeklyArtistCount:o}}catch(e){return console.error("Error fetching Last.fm stats:",e),null}}async function S(t,e){if(!await w(e))throw new Error("Last.fm username not found. Please check the username and try again.");const{error:n}=await m.from("user_providers").upsert({user_id:t,provider:"lastfm",provider_user_id:e,access_token:"public",refresh_token:"public",expires_at:new Date(Date.now()+365*24*60*60*1e3).toISOString(),connected_at:new Date().toISOString()},{onConflict:"user_id,provider"});if(n)throw console.error("Failed to store Last.fm connection:",n),new Error("Failed to save Last.fm connection")}async function T(t){const{data:e,error:r}=await m.from("user_providers").select("provider_user_id").eq("user_id",t).eq("provider","lastfm").maybeSingle();return r||!e?null:e.provider_user_id}async function A(t){const{error:e}=await m.from("user_providers").delete().eq("user_id",t).eq("provider","lastfm");if(e)throw new Error("Failed to disconnect Last.fm")}function D(){const{user:t}=l();return p({queryKey:["lastfm-username",t==null?void 0:t.id],queryFn:()=>T(t.id),enabled:!!t,staleTime:5*60*1e3})}function K(){const{user:t}=l(),{data:e}=D();return p({queryKey:["lastfm-stats",e],queryFn:()=>e?I(e):null,enabled:!!t&&!!e,staleTime:5*60*1e3,refetchOnWindowFocus:!0})}function x(){const{user:t}=l(),e=y();return g({mutationFn:async r=>{if(!t)throw new Error("Must be logged in");return await S(t.id,r),r},onSuccess:r=>{e.setQueryData(["lastfm-username",t==null?void 0:t.id],r),e.invalidateQueries({queryKey:["lastfm-stats"]}),e.invalidateQueries({queryKey:["user-providers"]})}})}function P(){const{user:t}=l(),e=y();return g({mutationFn:async()=>{if(!t)throw new Error("Must be logged in");await A(t.id)},onSuccess:()=>{e.setQueryData(["lastfm-username",t==null?void 0:t.id],null),e.setQueryData(["lastfm-stats",null],null),e.invalidateQueries({queryKey:["user-providers"]})}})}export{D as a,x as b,P as c,K as u};
