import{a as c,n as d,t as p,v as y}from"./index-DKc-Hno0.js";const F="https://ws.audioscrobbler.com/2.0";function v(e){const t=e.trim();if(!t)return"";const r=t.startsWith("@")?t.slice(1):t,s=r.match(/last\.fm\/user\/([^/?#]+)/i);if(s!=null&&s[1])try{return decodeURIComponent(s[1])}catch{return s[1]}const a=r.match(/\/user\/([^/?#]+)/i);if(a!=null&&a[1])try{return decodeURIComponent(a[1])}catch{return a[1]}if(r.includes("last.fm"))try{const i=new URL(/^https?:\/\//i.test(r)?r:`https://${r}`).pathname.split("/").filter(Boolean),n=i.findIndex(m=>m.toLowerCase()==="user"),u=n>=0?i[n+1]:void 0;if(u)return decodeURIComponent(u)}catch{}return r.replace(/\/+$/,"")}function k(){throw new Error("Last.fm API key not configured. Add VITE_LASTFM_API_KEY to your .env file.")}async function l(e,t){try{const r=k(),s=new URLSearchParams({method:e,api_key:r,format:"json",...t}),a=await fetch(`${F}?${s}`);if(!a.ok)return console.error(`Last.fm API error: ${a.status}`),null;const o=await a.json();return o.error?(console.error(`Last.fm error ${o.error}: ${o.message}`),null):o}catch(r){return console.error("Last.fm request failed:",r),null}}async function w(e){const t=await l("user.getInfo",{user:e});return(t==null?void 0:t.user)??null}async function I(e,t="3month",r=10){var a;const s=await l("user.getTopArtists",{user:e,period:t,limit:r.toString()});return((a=s==null?void 0:s.topartists)==null?void 0:a.artist)??[]}async function b(e,t="3month",r=10){var a;const s=await l("user.getTopTracks",{user:e,period:t,limit:r.toString()});return((a=s==null?void 0:s.toptracks)==null?void 0:a.track)??[]}async function g(e,t=20){var s;const r=await l("user.getRecentTracks",{user:e,limit:t.toString()});return((s=r==null?void 0:r.recenttracks)==null?void 0:s.track)??[]}async function A(e){var r,s;const t=await l("user.getWeeklyArtistChart",{user:e});return((s=(r=t==null?void 0:t.weeklyartistchart)==null?void 0:r.artist)==null?void 0:s.length)??0}async function T(e){if(!e)return null;try{const[t,r,s,a,o]=await Promise.all([w(e),I(e,"3month",10),b(e,"3month",10),g(e,10),A(e)]);if(!t)return null;const i=n=>{var m;if(!n||n.length===0)return;const u=["extralarge","large","medium","small"];for(const _ of u){const f=n.find(L=>L.size===_);if(f!=null&&f["#text"])return f["#text"]}return((m=n[0])==null?void 0:m["#text"])||void 0};return{totalScrobbles:parseInt(t.playcount,10)||0,artistCount:parseInt(t.artist_count,10)||0,trackCount:parseInt(t.track_count,10)||0,registeredDate:new Date(parseInt(t.registered.unixtime,10)*1e3),topArtists:r.map(n=>({name:n.name,playcount:parseInt(n.playcount,10)||0,imageUrl:i(n.image)})),topTracks:s.map(n=>({name:n.name,artist:n.artist.name,playcount:parseInt(n.playcount||"0",10)})),recentTracks:a.map(n=>{var u;return{name:n.name,artist:n.artist.name,album:(u=n.album)==null?void 0:u["#text"],playedAt:n.date?new Date(parseInt(n.date.uts,10)*1e3):void 0,imageUrl:i(n.image),nowPlaying:!n.date}}),weeklyArtistCount:o}}catch(t){return console.error("Error fetching Last.fm stats:",t),null}}async function q(e,t){const r=v(t);if(!r)throw new Error("Please enter your Last.fm username");if(!await w(r))throw new Error("Last.fm username not found. Please check the username and try again.");const a=async()=>{const{data:i,error:n}=await supabase.auth.updateUser({data:{lastfm_username:r}});if(n||!(i!=null&&i.user))throw new Error("Failed to save Last.fm connection")},{error:o}=await supabase.from("user_providers").upsert({user_id:e,provider:"lastfm",provider_user_id:r,access_token:"public",refresh_token:"public",expires_at:new Date(Date.now()+365*24*60*60*1e3).toISOString(),connected_at:new Date().toISOString()},{onConflict:"user_id,provider"});if(o){console.error("Failed to store Last.fm connection (user_providers):",o),await a();return}}async function S(e){var o,i;const{data:t,error:r}=await supabase.from("user_providers").select("provider_user_id").eq("user_id",e).eq("provider","lastfm").maybeSingle();if(!r&&(t!=null&&t.provider_user_id))return t.provider_user_id;const{data:s}=await supabase.auth.getUser(),a=(o=s==null?void 0:s.user)==null?void 0:o.user_metadata;return((i=s==null?void 0:s.user)==null?void 0:i.id)===e&&(a!=null&&a.lastfm_username)?a.lastfm_username:null}async function C(e){const{error:t}=await supabase.from("user_providers").delete().eq("user_id",e).eq("provider","lastfm");t&&console.warn("Failed to remove Last.fm from user_providers:",t);const{error:r}=await supabase.auth.updateUser({data:{lastfm_username:null}});if(r)throw new Error("Failed to disconnect Last.fm")}function h(){const{user:e}=c();return d({queryKey:["lastfm-username",e==null?void 0:e.id],queryFn:()=>S(e.id),enabled:!!e,staleTime:5*60*1e3})}function E(){const{user:e}=c(),{data:t}=h();return d({queryKey:["lastfm-stats",t],queryFn:()=>t?T(t):null,enabled:!!e&&!!t,staleTime:5*60*1e3,refetchOnWindowFocus:!0})}function P(e=200){const{user:t}=c(),{data:r}=h();return d({queryKey:["lastfm-recent",r,e],queryFn:()=>r?g(r,e):[],enabled:!!t&&!!r,staleTime:2*60*1e3,refetchOnWindowFocus:!0})}function x(){const{user:e}=c(),t=p();return y({mutationFn:async r=>{if(!e)throw new Error("Must be logged in");return await q(e.id,r),r},onSuccess:r=>{t.setQueryData(["lastfm-username",e==null?void 0:e.id],r),t.invalidateQueries({queryKey:["lastfm-stats"]}),t.invalidateQueries({queryKey:["user-providers"]})}})}function K(){const{user:e}=c(),t=p();return y({mutationFn:async()=>{if(!e)throw new Error("Must be logged in");await C(e.id)},onSuccess:()=>{t.setQueryData(["lastfm-username",e==null?void 0:e.id],null),t.setQueryData(["lastfm-stats",null],null),t.invalidateQueries({queryKey:["user-providers"]})}})}export{h as a,E as b,x as c,K as d,v as n,P as u};
