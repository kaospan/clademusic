import{h as P,u as U,a as I,r as c,j as e,L as T,B as b,ar as O,l as A,as as F}from"./index-BdTI9jwx.js";import{C as $}from"./circle-check-BGjnygYv.js";import{C as z}from"./circle-alert-CBHfDzsA.js";const L="https://accounts.spotify.com/api/token";function G(){const[r]=P(),a=U(),{user:l}=I(),[d,f]=c.useState("loading"),[C,j]=c.useState(""),g=c.useRef(!1),_=c.useRef(null);return c.useEffect(()=>{async function v(){var m;if(!g.current){g.current=!0;try{console.log("[Spotify Callback] Starting..."),console.log("[Spotify Callback] URL params:",Object.fromEntries(r.entries()));const o=r.get("code"),n=r.get("state"),p=r.get("error"),y=r.get("error_description");if(o){const t=`spotify_code_${o}`;if(_.current=t,localStorage.getItem(t)||sessionStorage.getItem(t)){console.warn("[Spotify Callback] Code already consumed, skipping re-exchange"),f("success"),setTimeout(()=>a("/profile",{replace:!0}),800);return}sessionStorage.setItem(t,"used"),localStorage.setItem(t,"used")}if(p)throw console.error("[Spotify Callback] Spotify error:",p,y),new Error(y||`Spotify authorization failed: ${p}`);if(!o||!n)throw console.error("[Spotify Callback] Missing code or state"),new Error("Missing authorization code or state");const s=O();if(console.log("[Spotify Callback] Stored state:",((m=s==null?void 0:s.state)==null?void 0:m.substring(0,8))+"..."),console.log("[Spotify Callback] Received state:",(n==null?void 0:n.substring(0,8))+"..."),!s||s.state!==n)throw console.error("[Spotify Callback] State mismatch"),new Error("Invalid state parameter. Please try connecting again.");if(!l)throw console.error("[Spotify Callback] No user logged in"),new Error("You must be logged in to connect Spotify");console.log("[Spotify Callback] Exchanging code for tokens...");const N="b1d936a5b2bd4cb199d3ede9a4fa2449",u="/clademusic/",D=u.endsWith("/")?u:`${u}/`,x="https://kaospan.github.io/clademusic/spotify-callback";console.log("[Spotify Callback] Using redirect URI:",x);const h=await fetch(L,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",code:o,redirect_uri:x,client_id:N,code_verifier:s.codeVerifier})});if(!h.ok){const t=await h.json();throw console.error("[Spotify Callback] Token exchange failed:",t),new Error(t.error_description||`Token exchange failed: ${t.error}`)}console.log("[Spotify Callback] Token exchange successful");try{const t=`${window.location.origin}${window.location.pathname}`;window.history.replaceState({},document.title,t)}catch(t){console.warn("[Spotify Callback] Failed to clean URL",t)}const i=await h.json();console.log("[Spotify Callback] Fetching Spotify profile...");const S=await fetch("https://api.spotify.com/v1/me",{headers:{Authorization:`Bearer ${i.access_token}`}});if(!S.ok)throw new Error("Failed to fetch Spotify profile");const E=await S.json(),R=new Date(Date.now()+i.expires_in*1e3).toISOString(),w={user_id:l.id,provider:"spotify",provider_user_id:E.id,access_token:i.access_token,expires_at:R,connected_at:new Date().toISOString()};i.refresh_token&&(w.refresh_token=i.refresh_token);const{error:k}=await A.from("user_providers").upsert(w,{onConflict:"user_id,provider"});if(k)throw console.error("Failed to store Spotify connection:",k),new Error("Failed to save Spotify connection");f("success"),setTimeout(()=>{a("/profile",{replace:!0})},2e3)}catch(o){console.error("Spotify callback error:",o),j(o instanceof Error?o.message:"Unknown error"),f("error")}finally{F()}}}v()},[r,l,a]),e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full text-center",children:[d==="loading"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(T,{size:"lg"}),e.jsx("h2",{className:"text-xl font-semibold",children:"Connecting to Spotify..."}),e.jsx("p",{className:"text-muted-foreground",children:"Please wait while we complete the connection"})]}),d==="success"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center mx-auto",children:e.jsx($,{className:"w-8 h-8 text-green-500"})}),e.jsx("h2",{className:"text-xl font-semibold text-green-500",children:"Spotify Connected!"}),e.jsx("p",{className:"text-muted-foreground",children:"Redirecting to your profile..."})]}),d==="error"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-destructive/20 flex items-center justify-center mx-auto",children:e.jsx(z,{className:"w-8 h-8 text-destructive"})}),e.jsx("h2",{className:"text-xl font-semibold text-destructive",children:"Connection Failed"}),e.jsx("p",{className:"text-muted-foreground",children:C}),e.jsxs("div",{className:"flex gap-2 justify-center mt-4",children:[e.jsx(b,{variant:"outline",onClick:()=>a("/profile"),children:"Go to Profile"}),e.jsx(b,{onClick:()=>a("/profile"),children:"Try Again"})]})]})]})})}export{G as default};
