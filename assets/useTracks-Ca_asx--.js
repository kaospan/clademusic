import{r as g,j as d,m as j,l as h,a as F,k as S,aN as A}from"./index-CM5px1PP.js";import{A as N}from"./index-DUn1e7eR.js";import{s as R}from"./seedTracks-B6rAh97_.js";import{g as D}from"./spotifySearchService-B0ozx_v1.js";let C=!1;function B({trackId:e,roomId:t="global",maxVisible:s=5,scrollSpeed:o=5e3}){const a=typeof window<"u"&&window.location.hostname.endsWith("github.io")||!e&&C,[p,u]=g.useState([]),[w,T]=g.useState([]);return g.useEffect(()=>{if(a)return;let r=null;return(async()=>{var y;let b=!1;try{const l=e?h.from("track_comments").select("id, content, profiles(full_name), created_at").eq("track_id",e).order("created_at",{ascending:!1}).limit(20):h.from("chat_messages").select("id, content, profiles(full_name), created_at").eq("room_id",t).order("created_at",{ascending:!1}).limit(20),{data:f,error:i}=await l;if(i&&((i==null?void 0:i.code)==="PGRST205"||(y=i==null?void 0:i.message)!=null&&y.includes("Could not find the table 'public.chat_messages'")?(console.warn("[ScrollingComments] chat_messages table missing; disabling global comments"),C=!0):console.warn("[ScrollingComments] skipping due to schema error",i),u([]),b=!0),f){const k=f.map(m=>{var x;return{id:m.id,content:m.content,author:((x=m.profiles)==null?void 0:x.full_name)||"Anonymous",created_at:m.created_at}});u(k.reverse())}}catch(l){console.error("Failed to load scrolling comments:",l),u([]),b=!0}if(b)return;const _=e?"track_comments":"chat_messages";r=h.channel(`scrolling-comments-${e||t}`).on("postgres_changes",{event:"INSERT",schema:"public",table:_,filter:e?`track_id=eq.${e}`:`room_id=eq.${t}`},async l=>{try{const{data:f,error:i}=await h.from("profiles").select("full_name").eq("id",l.new.user_id).single();if(i)throw i;const k={id:l.new.id,content:l.new.content,author:(f==null?void 0:f.full_name)||"Anonymous",created_at:l.new.created_at};u(m=>[...m,k])}catch(f){console.error("Failed to hydrate scrolling comment:",f)}}).subscribe()})(),()=>{r&&h.removeChannel(r)}},[e,t]),g.useEffect(()=>{if(a||p.length===0||s<=0||o<=0)return;const r=setInterval(()=>{u(c=>{if(c.length===0)return c;const[b,..._]=c;return T(y=>[...y,b].slice(-s)),_})},o/s);return()=>clearInterval(r)},[p.length,s,o]),g.useEffect(()=>{if(a||w.length===0)return;const r=setTimeout(()=>{T(c=>c.slice(1))},o);return()=>clearTimeout(r)},[w,o]),a?null:d.jsx("div",{className:"fixed bottom-24 left-0 right-0 z-40 pointer-events-none px-4 md:px-8",children:d.jsx("div",{className:"mx-auto max-w-2xl",children:d.jsx(N,{mode:"popLayout",children:w.map((r,c)=>d.jsx(j.div,{initial:{y:50,opacity:0},animate:{y:0,opacity:1-c*.15},exit:{y:-50,opacity:0},transition:{duration:.5,ease:"easeOut"},className:"mb-2",style:{filter:`blur(${c*.5}px)`},children:d.jsx("div",{className:"inline-block rounded-full bg-background/60 backdrop-blur-xl border border-border/30 px-4 py-2 shadow-lg",children:d.jsxs("p",{className:"text-sm text-foreground",children:[d.jsxs("span",{className:"font-semibold",children:[r.author,":"]})," ",d.jsx("span",{className:"font-normal",children:r.content})]})})},r.id))})})})}function I(e){return{...e,sections:Array.isArray(e.sections)?e.sections:void 0,detected_mode:e.detected_mode||void 0}}async function L(e){try{let t=h.from("tracks").select("*");if(e.id&&(t=t.eq("id",e.id)),e.spotifyId&&(t=t.eq("spotify_id",e.spotifyId)),e.youtubeId&&(t=t.eq("youtube_id",e.youtubeId)),e.search){const n=e.search.replace(/[%_,().*\\]/g,"");t=t.or(`title.ilike.%${n}%,artist.ilike.%${n}%`)}e.limit&&(t=t.limit(e.limit)),e.offset&&(t=t.range(e.offset,e.offset+(e.limit||20)-1));const{data:s,error:o}=await t;return o?(console.warn("Database fetch failed:",o.message),null):s?s.map(n=>I(n)):null}catch(t){return console.warn("Database fetch error:",t),null}}function $(e){let t=[...R];if(e.id&&(t=t.filter(n=>n.id===e.id)),e.spotifyId&&(t=t.filter(n=>n.spotify_id===e.spotifyId)),e.youtubeId&&(t=t.filter(n=>n.youtube_id===e.youtubeId)),e.search){const n=e.search.toLowerCase();t=t.filter(a=>{var p,u;return a.title.toLowerCase().includes(n)||((p=a.artist)==null?void 0:p.toLowerCase().includes(n))||((u=a.album)==null?void 0:u.toLowerCase().includes(n))})}const s=e.offset||0,o=e.limit||20;return t.slice(s,s+o)}async function v(e={}){const t=await L(e);if(t&&t.length>0)return{tracks:t,source:"database",total:t.length};const s=$(e);return{tracks:s,source:"seed",total:s.length}}async function K(e){return(await v({id:e,limit:1})).tracks[0]||null}async function Y(e=20){return v({limit:e})}const E={profile:["profile"],userProviders:["user-providers"],following:["following"],followers:["followers"],followingFeed:["following-feed"],TRACKS:"tracks",FEED:"feed",trackComments:e=>["track-comments",e],trackConnections:e=>["track-connections",e],playHistory:["play-history"],playStats:["play-stats"],userLocation:["user-location"],nearbyListeners:(e,t)=>["nearby-listeners",e,t],unifiedSearch:e=>["unified-search",e]};function G(e,t=!0){const{user:s}=F(),o=e==null?void 0:e.startsWith("spotify:");return S({queryKey:[E.TRACKS,"single",e],queryFn:async()=>{if(!e)return null;if(o&&s){const a=e.replace("spotify:","");return await D(s.id,a)}if(e==null?void 0:e.startsWith("youtube:")){const a=e.replace("youtube:","");return await A(a)}return await K(e)},enabled:!!e&&t,staleTime:10*60*1e3})}function H(e=20){return S({queryKey:[E.FEED,e],queryFn:()=>Y(e),staleTime:5*60*1e3})}export{B as S,G as a,H as u};
