import{r as f,j as i,m as S,o as l}from"./index-B9figJCG.js";import{A as N}from"./index-pD2ZkKkZ.js";let x=!1;function A({trackId:o,roomId:h="global",maxVisible:g=5,scrollSpeed:c=5e3}){const j=typeof window<"u"&&window.location.hostname.endsWith("github.io"),[y,m]=f.useState([]),[b,v]=f.useState([]);return j||!o&&x?null:(f.useEffect(()=>{let t=null;return(async()=>{var _;let d=!1,u=h;if(!o&&h==="global")try{const{data:e,error:n}=await l.from("chat_rooms").select("id").eq("type","global").limit(1).maybeSingle();if(n)throw n;if(!(e!=null&&e.id))throw new Error("Global chat room not found");u=e.id}catch(e){console.warn("[ScrollingComments] failed to resolve global chat room id; disabling global comments",e),x=!0;return}try{const e=o?l.from("track_comments").select("id, comment, user_id, created_at, profiles(display_name)").eq("track_id",o).order("created_at",{ascending:!1}).limit(20):l.from("chat_messages").select("id, message, user_id, created_at, profiles(display_name)").eq("room_id",u).order("created_at",{ascending:!1}).limit(20),{data:n,error:s}=await e;if(s&&((s==null?void 0:s.code)==="PGRST205"||(_=s==null?void 0:s.message)!=null&&_.includes("Could not find the table 'public.chat_messages'")?(console.warn("[ScrollingComments] chat_messages table missing; disabling global comments"),x=!0):console.warn("[ScrollingComments] skipping due to schema error",s),m([]),d=!0),n){const w=n.map(a=>{var C;return{id:a.id,content:a.comment??a.message??a.content??"",author:((C=a.profiles)==null?void 0:C.display_name)||"Anonymous",created_at:a.created_at}});m(w.reverse())}}catch(e){console.error("Failed to load scrolling comments:",e),m([]),d=!0}if(d)return;const p=o?"track_comments":"chat_messages";t=l.channel(`scrolling-comments-${o||h}`).on("postgres_changes",{event:"INSERT",schema:"public",table:p,filter:o?`track_id=eq.${o}`:`room_id=eq.${u}`},async e=>{try{const{data:n,error:s}=await l.from("profiles").select("display_name").eq("id",e.new.user_id).single();if(s)throw s;const w={id:e.new.id,content:e.new.comment??e.new.message??e.new.content??"",author:(n==null?void 0:n.display_name)||"Anonymous",created_at:e.new.created_at};m(a=>[...a,w])}catch(n){console.error("Failed to hydrate scrolling comment:",n)}}).subscribe()})(),()=>{t&&l.removeChannel(t)}},[o,h]),f.useEffect(()=>{if(y.length===0||g<=0||c<=0)return;const t=setInterval(()=>{m(r=>{if(r.length===0)return r;const[d,...u]=r;return v(p=>[...p,d].slice(-g)),u})},c/g);return()=>clearInterval(t)},[y.length,g,c]),f.useEffect(()=>{if(b.length===0)return;const t=setTimeout(()=>{v(r=>r.slice(1))},c);return()=>clearTimeout(t)},[b,c]),i.jsx("div",{className:"fixed bottom-24 left-0 right-0 z-40 pointer-events-none px-4 md:px-8",children:i.jsx("div",{className:"mx-auto max-w-2xl",children:i.jsx(N,{mode:"popLayout",children:b.map((t,r)=>i.jsx(S.div,{initial:{y:50,opacity:0},animate:{y:0,opacity:1-r*.15},exit:{y:-50,opacity:0},transition:{duration:.5,ease:"easeOut"},className:"mb-2",style:{filter:`blur(${r*.5}px)`},children:i.jsx("div",{className:"inline-block rounded-full bg-background/60 backdrop-blur-xl border border-border/30 px-4 py-2 shadow-lg",children:i.jsxs("p",{className:"text-sm text-foreground",children:[i.jsxs("span",{className:"font-semibold",children:[t.author,":"]})," ",i.jsx("span",{className:"font-normal",children:t.content})]})})},t.id))})})}))}export{A as S};
