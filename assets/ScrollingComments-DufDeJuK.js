import{j as e,r as d,m as C,q as u}from"./index-DbymZBjF.js";import{A as S}from"./index-BPeGxMLd.js";let N=!1;const f=typeof import.meta<"u"&&!1||typeof process<"u"&&!1;function k({trackId:r,roomId:h="global",maxVisible:p=5,scrollSpeed:l=5e3}){if(f)return e.jsx("div",{className:"fixed bottom-24 left-0 right-0 z-40 pointer-events-none px-4 md:px-8",children:e.jsx("div",{className:"mx-auto max-w-2xl",children:e.jsx("div",{className:"mb-2",children:e.jsx("div",{className:"inline-block rounded-full bg-background/60 backdrop-blur-xl border border-border/30 px-4 py-2 shadow-lg",children:e.jsxs("p",{className:"text-sm text-foreground",children:[e.jsx("span",{className:"font-semibold",children:"Test User:"})," ",e.jsx("span",{className:"font-normal",children:"Test comment"})]})})})})});const b=typeof window<"u"&&window.location.hostname.endsWith("github.io")||!r&&N,[j,c]=d.useState([]),[x,y]=d.useState([]);return d.useEffect(()=>{if(b)return;let t=null;return(async()=>{var g;let m=!1;try{const n=r?u.from("track_comments").select("id, content, profiles(full_name), created_at").eq("track_id",r).order("created_at",{ascending:!1}).limit(20):u.from("chat_messages").select("id, message, profiles(full_name), created_at").eq("room_id",h).order("created_at",{ascending:!1}).limit(20),{data:o,error:s}=await n;if(s&&((s==null?void 0:s.code)==="PGRST205"||(g=s==null?void 0:s.message)!=null&&g.includes("Could not find the table 'public.chat_messages'")?(f||console.warn("[ScrollingComments] chat_messages table missing; disabling global comments"),N=!0):f||console.warn("[ScrollingComments] skipping due to schema error",s),c([]),m=!0),o){const w=o.map(i=>{var v;return{id:i.id,content:i.content??i.message??"",author:((v=i.profiles)==null?void 0:v.full_name)||"Anonymous",created_at:i.created_at}});c(w.reverse())}}catch(n){f||console.error("Failed to load scrolling comments:",n),c([]),m=!0}if(m)return;const _=r?"track_comments":"chat_messages";t=u.channel(`scrolling-comments-${r||h}`).on("postgres_changes",{event:"INSERT",schema:"public",table:_,filter:r?`track_id=eq.${r}`:`room_id=eq.${h}`},async n=>{try{const{data:o,error:s}=await u.from("profiles").select("full_name").eq("id",n.new.user_id).single();if(s)throw s;const w={id:n.new.id,content:n.new.content??n.new.message??"",author:(o==null?void 0:o.full_name)||"Anonymous",created_at:n.new.created_at};c(i=>[...i,w])}catch(o){f||console.error("Failed to hydrate scrolling comment:",o)}}).subscribe()})(),()=>{t&&u.removeChannel(t)}},[r,h]),d.useEffect(()=>{if(b||j.length===0||p<=0||l<=0)return;const t=setInterval(()=>{c(a=>{if(a.length===0)return a;const[m,..._]=a;return y(g=>[...g,m].slice(-p)),_})},l/p);return()=>clearInterval(t)},[j.length,p,l]),d.useEffect(()=>{if(b||x.length===0)return;const t=setTimeout(()=>{y(a=>a.slice(1))},l);return()=>clearTimeout(t)},[x,l]),b?null:e.jsx("div",{className:"fixed bottom-24 left-0 right-0 z-40 pointer-events-none px-4 md:px-8",children:e.jsx("div",{className:"mx-auto max-w-2xl",children:e.jsx(S,{mode:"popLayout",children:x.map((t,a)=>e.jsx(C.div,{initial:{y:50,opacity:0},animate:{y:0,opacity:1-a*.15},exit:{y:-50,opacity:0},transition:{duration:.5,ease:"easeOut"},className:"mb-2",style:{filter:`blur(${a*.5}px)`},children:e.jsx("div",{className:"inline-block rounded-full bg-background/60 backdrop-blur-xl border border-border/30 px-4 py-2 shadow-lg",children:e.jsxs("p",{className:"text-sm text-foreground",children:[e.jsxs("span",{className:"font-semibold",children:[t.author,":"]})," ",e.jsx("span",{className:"font-normal",children:t.content})]})})},t.id))})})})}export{k as ScrollingComments};
