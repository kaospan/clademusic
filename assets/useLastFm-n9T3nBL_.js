import{l as c,a as d,k as p,p as y,q as w}from"./index-CEADtY0H.js";const L="https://ws.audioscrobbler.com/2.0";function k(e){const t=e.trim();if(!t)return"";const r=t.startsWith("@")?t.slice(1):t,n=r.match(/last\.fm\/user\/([^/?#]+)/i);if(n!=null&&n[1])try{return decodeURIComponent(n[1])}catch{return n[1]}const a=r.match(/\/user\/([^/?#]+)/i);if(a!=null&&a[1])try{return decodeURIComponent(a[1])}catch{return a[1]}if(r.includes("last.fm"))try{const i=new URL(/^https?:\/\//i.test(r)?r:`https://${r}`).pathname.split("/").filter(Boolean),s=i.findIndex(m=>m.toLowerCase()==="user"),u=s>=0?i[s+1]:void 0;if(u)return decodeURIComponent(u)}catch{}return r.replace(/\/+$/,"")}function v(){return"35ed8783bc2fca78c9b0dd99d8dcb9ef"}async function l(e,t){try{const r=v(),n=new URLSearchParams({method:e,api_key:r,format:"json",...t}),a=await fetch(`${L}?${n}`);if(!a.ok)return console.error(`Last.fm API error: ${a.status}`),null;const o=await a.json();return o.error?(console.error(`Last.fm error ${o.error}: ${o.message}`),null):o}catch(r){return console.error("Last.fm request failed:",r),null}}async function g(e){const t=await l("user.getInfo",{user:e});return(t==null?void 0:t.user)??null}async function F(e,t="3month",r=10){var a;const n=await l("user.getTopArtists",{user:e,period:t,limit:r.toString()});return((a=n==null?void 0:n.topartists)==null?void 0:a.artist)??[]}async function I(e,t="3month",r=10){var a;const n=await l("user.getTopTracks",{user:e,period:t,limit:r.toString()});return((a=n==null?void 0:n.toptracks)==null?void 0:a.track)??[]}async function b(e,t=20){var n;const r=await l("user.getRecentTracks",{user:e,limit:t.toString()});return((n=r==null?void 0:r.recenttracks)==null?void 0:n.track)??[]}async function q(e){var r,n;const t=await l("user.getWeeklyArtistChart",{user:e});return((n=(r=t==null?void 0:t.weeklyartistchart)==null?void 0:r.artist)==null?void 0:n.length)??0}async function S(e){if(!e)return null;try{const[t,r,n,a,o]=await Promise.all([g(e),F(e,"3month",10),I(e,"3month",10),b(e,10),q(e)]);if(!t)return null;const i=s=>{var m;if(!s||s.length===0)return;const u=["extralarge","large","medium","small"];for(const h of u){const f=s.find(_=>_.size===h);if(f!=null&&f["#text"])return f["#text"]}return((m=s[0])==null?void 0:m["#text"])||void 0};return{totalScrobbles:parseInt(t.playcount,10)||0,artistCount:parseInt(t.artist_count,10)||0,trackCount:parseInt(t.track_count,10)||0,registeredDate:new Date(parseInt(t.registered.unixtime,10)*1e3),topArtists:r.map(s=>({name:s.name,playcount:parseInt(s.playcount,10)||0,imageUrl:i(s.image)})),topTracks:n.map(s=>({name:s.name,artist:s.artist.name,playcount:parseInt(s.playcount||"0",10)})),recentTracks:a.map(s=>{var u;return{name:s.name,artist:s.artist.name,album:(u=s.album)==null?void 0:u["#text"],playedAt:s.date?new Date(parseInt(s.date.uts,10)*1e3):void 0,imageUrl:i(s.image),nowPlaying:!s.date}}),weeklyArtistCount:o}}catch(t){return console.error("Error fetching Last.fm stats:",t),null}}async function A(e,t){const r=k(t);if(!r)throw new Error("Please enter your Last.fm username");if(!await g(r))throw new Error("Last.fm username not found. Please check the username and try again.");const a=async()=>{const{data:i,error:s}=await c.auth.updateUser({data:{lastfm_username:r}});if(s||!(i!=null&&i.user))throw new Error("Failed to save Last.fm connection")},{error:o}=await c.from("user_providers").upsert({user_id:e,provider:"lastfm",provider_user_id:r,access_token:"public",refresh_token:"public",expires_at:new Date(Date.now()+365*24*60*60*1e3).toISOString(),connected_at:new Date().toISOString()},{onConflict:"user_id,provider"});if(o){console.error("Failed to store Last.fm connection (user_providers):",o),await a();return}}async function T(e){var o,i;const{data:t,error:r}=await c.from("user_providers").select("provider_user_id").eq("user_id",e).eq("provider","lastfm").maybeSingle();if(!r&&(t!=null&&t.provider_user_id))return t.provider_user_id;const{data:n}=await c.auth.getUser(),a=(o=n==null?void 0:n.user)==null?void 0:o.user_metadata;return((i=n==null?void 0:n.user)==null?void 0:i.id)===e&&(a!=null&&a.lastfm_username)?a.lastfm_username:null}async function C(e){const{error:t}=await c.from("user_providers").delete().eq("user_id",e).eq("provider","lastfm");t&&console.warn("Failed to remove Last.fm from user_providers:",t);const{error:r}=await c.auth.updateUser({data:{lastfm_username:null}});if(r)throw new Error("Failed to disconnect Last.fm")}function U(){const{user:e}=d();return p({queryKey:["lastfm-username",e==null?void 0:e.id],queryFn:()=>T(e.id),enabled:!!e,staleTime:5*60*1e3})}function E(){const{user:e}=d(),{data:t}=U();return p({queryKey:["lastfm-stats",t],queryFn:()=>t?S(t):null,enabled:!!e&&!!t,staleTime:5*60*1e3,refetchOnWindowFocus:!0})}function K(){const{user:e}=d(),t=y();return w({mutationFn:async r=>{if(!e)throw new Error("Must be logged in");return await A(e.id,r),r},onSuccess:r=>{t.setQueryData(["lastfm-username",e==null?void 0:e.id],r),t.invalidateQueries({queryKey:["lastfm-stats"]}),t.invalidateQueries({queryKey:["user-providers"]})}})}function P(){const{user:e}=d(),t=y();return w({mutationFn:async()=>{if(!e)throw new Error("Must be logged in");await C(e.id)},onSuccess:()=>{t.setQueryData(["lastfm-username",e==null?void 0:e.id],null),t.setQueryData(["lastfm-stats",null],null),t.invalidateQueries({queryKey:["user-providers"]})}})}export{U as a,K as b,P as c,k as n,E as u};
