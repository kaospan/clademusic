import{r as b,j as u,m as v,h as g,a as C,g as k,av as E}from"./index-GNu0OiLQ.js";import{A as j}from"./index-ChrSsGa6.js";import{s as F}from"./seedTracks-B6rAh97_.js";import{g as A}from"./spotifySearchService-DnYBs2Pb.js";let x=!1;function z({trackId:e,roomId:t="global",maxVisible:r=5,scrollSpeed:a=5e3}){const[s,n]=b.useState([]),[f,d]=b.useState([]);return b.useEffect(()=>{let o=null;return(async()=>{if(!e&&x){n([]);return}let p=!1;try{const i=e?g.from("track_comments").select("id, content, profiles(full_name), created_at").eq("track_id",e).order("created_at",{ascending:!1}).limit(20):g.from("chat_messages").select("id, content, profiles(full_name), created_at").eq("room_id",t).order("created_at",{ascending:!1}).limit(20),{data:l,error:h}=await i;if(h&&(console.warn("[ScrollingComments] skipping due to schema error",h),n([]),p=!0,e||(x=!0)),l){const _=l.map(m=>{var w;return{id:m.id,content:m.content,author:((w=m.profiles)==null?void 0:w.full_name)||"Anonymous",created_at:m.created_at}});n(_.reverse())}}catch(i){console.error("Failed to load scrolling comments:",i),n([]),p=!0}if(p)return;const y=e?"track_comments":"chat_messages";o=g.channel(`scrolling-comments-${e||t}`).on("postgres_changes",{event:"INSERT",schema:"public",table:y,filter:e?`track_id=eq.${e}`:`room_id=eq.${t}`},async i=>{try{const{data:l,error:h}=await g.from("profiles").select("full_name").eq("id",i.new.user_id).single();if(h)throw h;const _={id:i.new.id,content:i.new.content,author:(l==null?void 0:l.full_name)||"Anonymous",created_at:i.new.created_at};n(m=>[...m,_])}catch(l){console.error("Failed to hydrate scrolling comment:",l)}}).subscribe()})(),()=>{o==null||o.unsubscribe()}},[e,t]),b.useEffect(()=>{if(s.length===0)return;const o=setInterval(()=>{n(c=>{if(c.length===0)return c;const[p,...y]=c;return d(i=>[...i,p].slice(-r)),y})},a/r);return()=>clearInterval(o)},[s.length,r,a]),b.useEffect(()=>{if(f.length===0)return;const o=setTimeout(()=>{d(c=>c.slice(1))},a);return()=>clearTimeout(o)},[f,a]),u.jsx("div",{className:"fixed bottom-24 left-0 right-0 z-40 pointer-events-none px-4 md:px-8",children:u.jsx("div",{className:"mx-auto max-w-2xl",children:u.jsx(j,{mode:"popLayout",children:f.map((o,c)=>u.jsx(v.div,{initial:{y:50,opacity:0},animate:{y:0,opacity:1-c*.15},exit:{y:-50,opacity:0},transition:{duration:.5,ease:"easeOut"},className:"mb-2",style:{filter:`blur(${c*.5}px)`},children:u.jsx("div",{className:"inline-block rounded-full bg-background/60 backdrop-blur-xl border border-border/30 px-4 py-2 shadow-lg",children:u.jsxs("p",{className:"text-sm text-foreground",children:[u.jsxs("span",{className:"font-semibold",children:[o.author,":"]})," ",u.jsx("span",{className:"font-normal",children:o.content})]})})},o.id))})})})}function N(e){return{...e,sections:Array.isArray(e.sections)?e.sections:void 0,detected_mode:e.detected_mode||void 0}}async function R(e){try{let t=g.from("tracks").select("*");if(e.id&&(t=t.eq("id",e.id)),e.spotifyId&&(t=t.eq("spotify_id",e.spotifyId)),e.youtubeId&&(t=t.eq("youtube_id",e.youtubeId)),e.search){const s=e.search.replace(/[%_,().*\\]/g,"");t=t.or(`title.ilike.%${s}%,artist.ilike.%${s}%`)}e.limit&&(t=t.limit(e.limit)),e.offset&&(t=t.range(e.offset,e.offset+(e.limit||20)-1));const{data:r,error:a}=await t;return a?(console.warn("Database fetch failed:",a.message),null):r?r.map(s=>N(s)):null}catch(t){return console.warn("Database fetch error:",t),null}}function L(e){let t=[...F];if(e.id&&(t=t.filter(s=>s.id===e.id)),e.spotifyId&&(t=t.filter(s=>s.spotify_id===e.spotifyId)),e.youtubeId&&(t=t.filter(s=>s.youtube_id===e.youtubeId)),e.search){const s=e.search.toLowerCase();t=t.filter(n=>{var f,d;return n.title.toLowerCase().includes(s)||((f=n.artist)==null?void 0:f.toLowerCase().includes(s))||((d=n.album)==null?void 0:d.toLowerCase().includes(s))})}const r=e.offset||0,a=e.limit||20;return t.slice(r,r+a)}async function T(e={}){const t=await R(e);if(t&&t.length>0)return{tracks:t,source:"database",total:t.length};const r=L(e);return{tracks:r,source:"seed",total:r.length}}async function I(e){return(await T({id:e,limit:1})).tracks[0]||null}async function $(e=20){return T({limit:e})}const S={profile:["profile"],userProviders:["user-providers"],following:["following"],followers:["followers"],followingFeed:["following-feed"],TRACKS:"tracks",FEED:"feed",trackComments:e=>["track-comments",e],trackConnections:e=>["track-connections",e],playHistory:["play-history"],playStats:["play-stats"],userLocation:["user-location"],nearbyListeners:(e,t)=>["nearby-listeners",e,t],unifiedSearch:e=>["unified-search",e]};function P(e,t=!0){const{user:r}=C(),a=e==null?void 0:e.startsWith("spotify:");return k({queryKey:[S.TRACKS,"single",e],queryFn:async()=>{if(!e)return null;if(a&&r){const n=e.replace("spotify:","");return await A(r.id,n)}if(e==null?void 0:e.startsWith("youtube:")){const n=e.replace("youtube:","");return await E(n)}return await I(e)},enabled:!!e&&t,staleTime:10*60*1e3})}function W(e=20){return k({queryKey:[S.FEED,e],queryFn:()=>$(e),staleTime:5*60*1e3})}export{z as S,P as a,W as u};
