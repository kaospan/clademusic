import{h as U,u as I,a as $,r as l,j as o,L as F,B as j,ar as O,l as A,as as z}from"./index-lxXs3g0S.js";import{C as L}from"./circle-check-zrsQosaf.js";import{C as D}from"./circle-alert-Bvjuw8tE.js";const B="https://accounts.spotify.com/api/token";function V(){const[s]=U(),c=I(),{user:d}=$(),[f,p]=l.useState("loading"),[_,v]=l.useState(""),m=l.useRef(!1),N=l.useRef(null);return l.useEffect(()=>{async function E(){var y,x;if(!m.current){m.current=!0;try{console.log("[Spotify Callback] Starting..."),console.log("[Spotify Callback] URL params:",Object.fromEntries(s.entries()));const t=s.get("code"),i=s.get("state"),u=s.get("error"),S=s.get("error_description");if(t){const e=`spotify_code_${t}`;if(N.current=e,localStorage.getItem(e)||sessionStorage.getItem(e)){console.warn("[Spotify Callback] Code already consumed, skipping re-exchange"),p("success"),setTimeout(()=>c("/profile",{replace:!0}),800);return}sessionStorage.setItem(e,"used"),localStorage.setItem(e,"used")}if(u)throw console.error("[Spotify Callback] Spotify error:",u,S),new Error(S||`Spotify authorization failed: ${u}`);if(!t||!i)throw console.error("[Spotify Callback] Missing code or state"),new Error("Missing authorization code or state");const a=O();if(console.log("[Spotify Callback] Stored state:",((y=a==null?void 0:a.state)==null?void 0:y.substring(0,8))+"..."),console.log("[Spotify Callback] Received state:",(i==null?void 0:i.substring(0,8))+"..."),!a||a.state!==i)throw console.error("[Spotify Callback] State mismatch"),new Error("Invalid state parameter. Please try connecting again.");if(!d)throw console.error("[Spotify Callback] No user logged in"),new Error("You must be logged in to connect Spotify");console.log("[Spotify Callback] Exchanging code for tokens...");const R="b1d936a5b2bd4cb199d3ede9a4fa2449",h="/clademusic/",M=h.endsWith("/")?h:`${h}/`,w="https://kaospan.github.io/clademusic/spotify-callback";console.log("[Spotify Callback] Using redirect URI:",w);const g=await fetch(B,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",code:t,redirect_uri:w,client_id:R,code_verifier:a.codeVerifier})});if(!g.ok){const e=await g.json();throw console.error("[Spotify Callback] Token exchange failed:",e),new Error(e.error_description||`Token exchange failed: ${e.error}`)}console.log("[Spotify Callback] Token exchange successful");try{const e=`${window.location.origin}${window.location.pathname}`;window.history.replaceState({},document.title,e)}catch(e){console.warn("[Spotify Callback] Failed to clean URL",e)}const r=await g.json();console.log("[Spotify Callback] Token scope:",typeof r.scope=="string"?r.scope:"(missing)"),console.log("[Spotify Callback] Fetching Spotify profile...");const n=await fetch("https://api.spotify.com/v1/me",{headers:{Authorization:`Bearer ${r.access_token}`}});if(!n.ok){const e=await n.json().catch(()=>null);console.error("[Spotify Callback] Profile fetch failed:",n.status,e);const C=((x=e==null?void 0:e.error)==null?void 0:x.message)||(e==null?void 0:e.message)||n.statusText||"Forbidden";throw new Error(`Failed to fetch Spotify profile (${n.status}): ${C}`)}const P=await n.json(),T=new Date(Date.now()+r.expires_in*1e3).toISOString(),k={user_id:d.id,provider:"spotify",provider_user_id:P.id,access_token:r.access_token,expires_at:T,connected_at:new Date().toISOString()};r.refresh_token&&(k.refresh_token=r.refresh_token);const{error:b}=await A.from("user_providers").upsert(k,{onConflict:"user_id,provider"});if(b)throw console.error("Failed to store Spotify connection:",b),new Error("Failed to save Spotify connection");p("success"),setTimeout(()=>{c("/profile",{replace:!0})},2e3)}catch(t){console.error("Spotify callback error:",t),v(t instanceof Error?t.message:"Unknown error"),p("error")}finally{z()}}}E()},[s,d,c]),o.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:o.jsxs("div",{className:"max-w-md w-full text-center",children:[f==="loading"&&o.jsxs("div",{className:"space-y-4",children:[o.jsx(F,{size:"lg"}),o.jsx("h2",{className:"text-xl font-semibold",children:"Connecting to Spotify..."}),o.jsx("p",{className:"text-muted-foreground",children:"Please wait while we complete the connection"})]}),f==="success"&&o.jsxs("div",{className:"space-y-4",children:[o.jsx("div",{className:"w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center mx-auto",children:o.jsx(L,{className:"w-8 h-8 text-green-500"})}),o.jsx("h2",{className:"text-xl font-semibold text-green-500",children:"Spotify Connected!"}),o.jsx("p",{className:"text-muted-foreground",children:"Redirecting to your profile..."})]}),f==="error"&&o.jsxs("div",{className:"space-y-4",children:[o.jsx("div",{className:"w-16 h-16 rounded-full bg-destructive/20 flex items-center justify-center mx-auto",children:o.jsx(D,{className:"w-8 h-8 text-destructive"})}),o.jsx("h2",{className:"text-xl font-semibold text-destructive",children:"Connection Failed"}),o.jsx("p",{className:"text-muted-foreground",children:_}),o.jsxs("div",{className:"flex gap-2 justify-center mt-4",children:[o.jsx(j,{variant:"outline",onClick:()=>c("/profile"),children:"Go to Profile"}),o.jsx(j,{onClick:()=>c("/profile"),children:"Try Again"})]})]})]})})}export{V as default};
