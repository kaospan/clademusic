import{l as u,a as f,k as p,p as y,q as w}from"./index-BDfAa4DI.js";const k="https://ws.audioscrobbler.com/2.0";function L(){return"35ed8783bc2fca78c9b0dd99d8dcb9ef"}async function c(e,t){try{const r=L(),s=new URLSearchParams({method:e,api_key:r,format:"json",...t}),a=await fetch(`${k}?${s}`);if(!a.ok)return console.error(`Last.fm API error: ${a.status}`),null;const o=await a.json();return o.error?(console.error(`Last.fm error ${o.error}: ${o.message}`),null):o}catch(r){return console.error("Last.fm request failed:",r),null}}async function g(e){const t=await c("user.getInfo",{user:e});return(t==null?void 0:t.user)??null}async function v(e,t="3month",r=10){var a;const s=await c("user.getTopArtists",{user:e,period:t,limit:r.toString()});return((a=s==null?void 0:s.topartists)==null?void 0:a.artist)??[]}async function F(e,t="3month",r=10){var a;const s=await c("user.getTopTracks",{user:e,period:t,limit:r.toString()});return((a=s==null?void 0:s.toptracks)==null?void 0:a.track)??[]}async function b(e,t=20){var s;const r=await c("user.getRecentTracks",{user:e,limit:t.toString()});return((s=r==null?void 0:r.recenttracks)==null?void 0:s.track)??[]}async function q(e){var r,s;const t=await c("user.getWeeklyArtistChart",{user:e});return((s=(r=t==null?void 0:t.weeklyartistchart)==null?void 0:r.artist)==null?void 0:s.length)??0}async function I(e){if(!e)return null;try{const[t,r,s,a,o]=await Promise.all([g(e),v(e,"3month",10),F(e,"3month",10),b(e,10),q(e)]);if(!t)return null;const i=n=>{var d;if(!n||n.length===0)return;const l=["extralarge","large","medium","small"];for(const _ of l){const m=n.find(h=>h.size===_);if(m!=null&&m["#text"])return m["#text"]}return((d=n[0])==null?void 0:d["#text"])||void 0};return{totalScrobbles:parseInt(t.playcount,10)||0,artistCount:parseInt(t.artist_count,10)||0,trackCount:parseInt(t.track_count,10)||0,registeredDate:new Date(parseInt(t.registered.unixtime,10)*1e3),topArtists:r.map(n=>({name:n.name,playcount:parseInt(n.playcount,10)||0,imageUrl:i(n.image)})),topTracks:s.map(n=>({name:n.name,artist:n.artist.name,playcount:parseInt(n.playcount||"0",10)})),recentTracks:a.map(n=>{var l;return{name:n.name,artist:n.artist.name,album:(l=n.album)==null?void 0:l["#text"],playedAt:n.date?new Date(parseInt(n.date.uts,10)*1e3):void 0,imageUrl:i(n.image),nowPlaying:!n.date}}),weeklyArtistCount:o}}catch(t){return console.error("Error fetching Last.fm stats:",t),null}}async function S(e,t){if(!await g(t))throw new Error("Last.fm username not found. Please check the username and try again.");const s=async()=>{const{data:o,error:i}=await u.auth.updateUser({data:{lastfm_username:t}});if(i||!(o!=null&&o.user))throw new Error("Failed to save Last.fm connection")},{error:a}=await u.from("user_providers").upsert({user_id:e,provider:"lastfm",provider_user_id:t,access_token:"public",refresh_token:"public",expires_at:new Date(Date.now()+365*24*60*60*1e3).toISOString(),connected_at:new Date().toISOString()},{onConflict:"user_id,provider"});if(a){console.error("Failed to store Last.fm connection (user_providers):",a),await s();return}}async function T(e){var o,i;const{data:t,error:r}=await u.from("user_providers").select("provider_user_id").eq("user_id",e).eq("provider","lastfm").maybeSingle();if(!r&&(t!=null&&t.provider_user_id))return t.provider_user_id;const{data:s}=await u.auth.getUser(),a=(o=s==null?void 0:s.user)==null?void 0:o.user_metadata;return((i=s==null?void 0:s.user)==null?void 0:i.id)===e&&(a!=null&&a.lastfm_username)?a.lastfm_username:null}async function A(e){const{error:t}=await u.from("user_providers").delete().eq("user_id",e).eq("provider","lastfm");t&&console.warn("Failed to remove Last.fm from user_providers:",t);const{error:r}=await u.auth.updateUser({data:{lastfm_username:null}});if(r)throw new Error("Failed to disconnect Last.fm")}function U(){const{user:e}=f();return p({queryKey:["lastfm-username",e==null?void 0:e.id],queryFn:()=>T(e.id),enabled:!!e,staleTime:5*60*1e3})}function K(){const{user:e}=f(),{data:t}=U();return p({queryKey:["lastfm-stats",t],queryFn:()=>t?I(t):null,enabled:!!e&&!!t,staleTime:5*60*1e3,refetchOnWindowFocus:!0})}function x(){const{user:e}=f(),t=y();return w({mutationFn:async r=>{if(!e)throw new Error("Must be logged in");return await S(e.id,r),r},onSuccess:r=>{t.setQueryData(["lastfm-username",e==null?void 0:e.id],r),t.invalidateQueries({queryKey:["lastfm-stats"]}),t.invalidateQueries({queryKey:["user-providers"]})}})}function E(){const{user:e}=f(),t=y();return w({mutationFn:async()=>{if(!e)throw new Error("Must be logged in");await A(e.id)},onSuccess:()=>{t.setQueryData(["lastfm-username",e==null?void 0:e.id],null),t.setQueryData(["lastfm-stats",null],null),t.invalidateQueries({queryKey:["user-providers"]})}})}export{U as a,x as b,E as c,K as u};
