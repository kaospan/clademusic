import{r as d,j as r,m as S,o as f}from"./index-C16OUfry.js";import{A as N}from"./index-DPi_3kzz.js";let C=!1;const c=typeof import.meta<"u"&&!1||typeof process<"u"&&!1;function A({trackId:o,roomId:h="global",maxVisible:g=5,scrollSpeed:l=5e3}){const p=typeof window<"u"&&window.location.hostname.endsWith("github.io")||!o&&C,[y,m]=d.useState([]),[_,j]=d.useState(()=>c?[{id:"test-comment",content:"Test comment",author:"Test User",created_at:new Date().toISOString()}]:[]);return d.useEffect(()=>{if(p)return;let e=null;return(async()=>{var b;let u=!1;try{const n=o?f.from("track_comments").select("id, content, profiles(full_name), created_at").eq("track_id",o).order("created_at",{ascending:!1}).limit(20):f.from("chat_messages").select("id, message, profiles(full_name), created_at").eq("room_id",h).order("created_at",{ascending:!1}).limit(20),{data:a,error:t}=await n;if(t&&((t==null?void 0:t.code)==="PGRST205"||(b=t==null?void 0:t.message)!=null&&b.includes("Could not find the table 'public.chat_messages'")?(c||console.warn("[ScrollingComments] chat_messages table missing; disabling global comments"),C=!0):c||console.warn("[ScrollingComments] skipping due to schema error",t),m([]),u=!0),a){const w=a.map(i=>{var v;return{id:i.id,content:i.content??i.message??"",author:((v=i.profiles)==null?void 0:v.full_name)||"Anonymous",created_at:i.created_at}});m(w.reverse())}}catch(n){c||console.error("Failed to load scrolling comments:",n),m([]),u=!0}if(u)return;const x=o?"track_comments":"chat_messages";e=f.channel(`scrolling-comments-${o||h}`).on("postgres_changes",{event:"INSERT",schema:"public",table:x,filter:o?`track_id=eq.${o}`:`room_id=eq.${h}`},async n=>{try{const{data:a,error:t}=await f.from("profiles").select("full_name").eq("id",n.new.user_id).single();if(t)throw t;const w={id:n.new.id,content:n.new.content??n.new.message??"",author:(a==null?void 0:a.full_name)||"Anonymous",created_at:n.new.created_at};m(i=>[...i,w])}catch(a){c||console.error("Failed to hydrate scrolling comment:",a)}}).subscribe()})(),()=>{e&&f.removeChannel(e)}},[o,h]),d.useEffect(()=>{if(p||y.length===0||g<=0||l<=0)return;const e=setInterval(()=>{m(s=>{if(s.length===0)return s;const[u,...x]=s;return j(b=>[...b,u].slice(-g)),x})},l/g);return()=>clearInterval(e)},[y.length,g,l]),d.useEffect(()=>{if(p||_.length===0)return;const e=setTimeout(()=>{j(s=>s.slice(1))},l);return()=>clearTimeout(e)},[_,l]),p&&!c?null:r.jsx("div",{className:"fixed bottom-24 left-0 right-0 z-40 pointer-events-none px-4 md:px-8",children:r.jsx("div",{className:"mx-auto max-w-2xl",children:r.jsx(N,{mode:"popLayout",children:_.map((e,s)=>r.jsx(S.div,{initial:{y:50,opacity:0},animate:{y:0,opacity:1-s*.15},exit:{y:-50,opacity:0},transition:{duration:.5,ease:"easeOut"},className:"mb-2",style:{filter:`blur(${s*.5}px)`},children:r.jsx("div",{className:"inline-block rounded-full bg-background/60 backdrop-blur-xl border border-border/30 px-4 py-2 shadow-lg",children:r.jsxs("p",{className:"text-sm text-foreground",children:[r.jsxs("span",{className:"font-semibold",children:[e.author,":"]})," ",r.jsx("span",{className:"font-normal",children:e.content})]})})},e.id))})})})}export{A as ScrollingComments};
