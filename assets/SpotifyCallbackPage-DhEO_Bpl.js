import{h as K,u as Q,p as $,a as q,r as n,j as e,L as O,B as j,ar as A,l as z,as as D}from"./index-CMpRMcvj.js";import{C as F}from"./circle-check-DpSdaDWV.js";import{C as L}from"./circle-alert-CBwnwNIG.js";const M="https://accounts.spotify.com/api/token";function V(){const[a]=K(),c=Q(),o=$(),{user:l}=q(),[p,y]=n.useState("loading"),[_,N]=n.useState(""),[x,E]=n.useState(""),S=n.useRef(!1),R=n.useRef(null);return n.useEffect(()=>{async function P(){var w;if(!S.current){S.current=!0;try{console.log("[Spotify Callback] Starting..."),console.log("[Spotify Callback] URL params:",Object.fromEntries(a.entries()));const s=a.get("code"),d=a.get("state"),h=a.get("error"),k=a.get("error_description");if(s){const t=`spotify_code_${s}`;if(R.current=t,localStorage.getItem(t)||sessionStorage.getItem(t)){console.warn("[Spotify Callback] Code already consumed, skipping re-exchange"),y("success"),setTimeout(()=>c("/profile",{replace:!0}),800);return}sessionStorage.setItem(t,"used"),localStorage.setItem(t,"used")}if(h)throw console.error("[Spotify Callback] Spotify error:",h,k),new Error(k||`Spotify authorization failed: ${h}`);if(!s||!d)throw console.error("[Spotify Callback] Missing code or state"),new Error("Missing authorization code or state");const i=A();if(console.log("[Spotify Callback] Stored state:",((w=i==null?void 0:i.state)==null?void 0:w.substring(0,8))+"..."),console.log("[Spotify Callback] Received state:",(d==null?void 0:d.substring(0,8))+"..."),!i||i.state!==d)throw console.error("[Spotify Callback] State mismatch"),new Error("Invalid state parameter. Please try connecting again.");if(!l)throw console.error("[Spotify Callback] No user logged in"),new Error("You must be logged in to connect Spotify");console.log("[Spotify Callback] Exchanging code for tokens...");const T="",m="/clademusic/",I=m.endsWith("/")?m:`${m}/`,b=`${window.location.origin}${I}spotify-callback`;console.log("[Spotify Callback] Using redirect URI:",b);const g=await fetch(M,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",code:s,redirect_uri:b,client_id:T,code_verifier:i.codeVerifier})});if(!g.ok){const t=await g.json();throw console.error("[Spotify Callback] Token exchange failed:",t),new Error(t.error_description||`Token exchange failed: ${t.error}`)}console.log("[Spotify Callback] Token exchange successful");try{const t=`${window.location.origin}${window.location.pathname}`;window.history.replaceState({},document.title,t)}catch(t){console.warn("[Spotify Callback] Failed to clean URL",t)}const r=await g.json();console.log("[Spotify Callback] Token scope:",typeof r.scope=="string"?r.scope:"(missing)");let f=null;console.log("[Spotify Callback] Fetching Spotify profile...");const u=await fetch("https://api.spotify.com/v1/me",{headers:{Authorization:`Bearer ${r.access_token}`}});if(u.ok)f=await u.json();else{const t=await u.json().catch(()=>null);console.error("[Spotify Callback] Profile fetch failed:",u.status,t)}const U=new Date(Date.now()+r.expires_in*1e3).toISOString(),C={user_id:l.id,provider:"spotify",provider_user_id:(f==null?void 0:f.id)||`unknown_${l.id}`,access_token:r.access_token,expires_at:U,connected_at:new Date().toISOString()};r.refresh_token&&(C.refresh_token=r.refresh_token);const{error:v}=await z.from("user_providers").upsert(C,{onConflict:"user_id,provider"});if(v)throw console.error("Failed to store Spotify connection:",v),new Error("Failed to save Spotify connection");o.setQueryData(["spotify-connected",l.id],!0),o.invalidateQueries({queryKey:["spotify-connected"]}),o.invalidateQueries({queryKey:["user-providers"]}),o.invalidateQueries({queryKey:["spotify-profile"]}),o.invalidateQueries({queryKey:["spotify-recently-played"]}),o.invalidateQueries({queryKey:["spotify-top-tracks"]}),o.invalidateQueries({queryKey:["spotify-top-artists"]}),o.invalidateQueries({queryKey:["music-stats"]}),o.invalidateQueries({queryKey:["spotify-recommendations"]}),y("success"),f||(console.warn("[Spotify Callback] Connected, but profile fetch failed. This often means the Spotify app is in dev mode and the user is not added as an allowed user in the Spotify dashboard."),E("Connected, but Spotify profile fetch was blocked (403). If your Spotify app is in dev mode, add your account as an allowed user in the Spotify dashboard, then reconnect.")),setTimeout(()=>{c("/profile",{replace:!0})},2e3)}catch(s){console.error("Spotify callback error:",s),N(s instanceof Error?s.message:"Unknown error"),y("error")}finally{D()}}}P()},[a,l,c,o]),e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full text-center",children:[p==="loading"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(O,{size:"lg"}),e.jsx("h2",{className:"text-xl font-semibold",children:"Connecting to Spotify..."}),e.jsx("p",{className:"text-muted-foreground",children:"Please wait while we complete the connection"})]}),p==="success"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center mx-auto",children:e.jsx(F,{className:"w-8 h-8 text-green-500"})}),e.jsx("h2",{className:"text-xl font-semibold text-green-500",children:"Spotify Connected!"}),e.jsx("p",{className:"text-muted-foreground",children:"Redirecting to your profile..."}),x&&e.jsx("p",{className:"text-sm text-amber-500/90",children:x})]}),p==="error"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-destructive/20 flex items-center justify-center mx-auto",children:e.jsx(L,{className:"w-8 h-8 text-destructive"})}),e.jsx("h2",{className:"text-xl font-semibold text-destructive",children:"Connection Failed"}),e.jsx("p",{className:"text-muted-foreground",children:_}),e.jsxs("div",{className:"flex gap-2 justify-center mt-4",children:[e.jsx(j,{variant:"outline",onClick:()=>c("/profile"),children:"Go to Profile"}),e.jsx(j,{onClick:()=>c("/profile"),children:"Try Again"})]})]})]})})}export{V as default};
