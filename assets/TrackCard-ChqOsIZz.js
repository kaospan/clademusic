import{c as R,j as e,m as p,M as le,a as P,v as F,o as C,n as V,t as Z,r as y,u as G,aS as J,aT as ee,aU as se,aV as te,aW as ae,B as S,S as de,h as ce,T as me,U as ue,V as he,w as xe,e as K,p as $,P as ie,aX as pe,ap as fe,Q as ge,X as ye}from"./index-FBrkeiAb.js";import{C as be}from"./ChordBadge-AEIYMF2U.js";import{K as je,R as we}from"./rotate-ccw-v0BNKUF5.js";import{D as ve,a as Ne,E as _e,b as Ce,c as k,d as H,T as Se}from"./TrackComments-4Gbxiiqv.js";import{S as Me}from"./switch-Drs-Hovr.js";import{S as Pe,b as Te}from"./useFollowing-DBCTVbTF.js";import{L as W}from"./label-BQR167Wn.js";import{U}from"./users-fOCvtxg5.js";import{A as O}from"./index-COIQpKr8.js";import{M as D}from"./map-pin-By0Npqfe.js";import{R as Ae}from"./radio-DmIJ-DGx.js";import{f as ke}from"./formatDistanceToNow-3UBXKcFR.js";import{S as E}from"./share-2-Bp2KU4yb.js";import{L as ne}from"./BottomNav-Bski3Rib.js";import{C as Ie}from"./check-4LTCdVwo.js";import{T as qe}from"./twitter-53UoDjiv.js";import{M as ze,S as $e}from"./send-ALBdq1sQ.js";import{b as Y}from"./timeFormat-1gw3rh39.js";import{U as Re}from"./user-4-WuAq6N.js";import{M as De}from"./music-2-CjZE9x2_.js";import{A as Le}from"./ProfileCircle-BOlyNdo1.js";import{S as Ue}from"./sparkles-4VzCGd8z.js";import{H as Ee}from"./heart-C5lihb58.js";import{W as Oe}from"./waves-BTxLfqQx.js";import{B as Fe}from"./bookmark-BtXTNfgA.js";import{M as Ve}from"./search-DYzDnr7R.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=R("Album",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["polyline",{points:"11 3 11 11 14 8 17 11 17 3",key:"1wcwz3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=R("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=R("Settings2",[["path",{d:"M20 7h-9",key:"3s1dr2"}],["path",{d:"M14 17H5",key:"gfn3mx"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=R("SquarePlay",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"m9 8 6 4-6 4Z",key:"f1r3lt"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=R("Youtube",[["path",{d:"M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 1.4-1.4 49.56 49.56 0 0 1 16.2 0A2 2 0 0 1 21.5 7a24.12 24.12 0 0 1 0 10 2 2 0 0 1-1.4 1.4 49.55 49.55 0 0 1-16.2 0A2 2 0 0 1 2.5 17",key:"1q2vi4"}],["path",{d:"m10 15 5-3-5-3z",key:"1jp15x"}]]);function Ye({progression:s,detectedKey:t,detectedMode:a,cadenceType:i,confidenceScore:d,matchReason:h}){return e.jsxs(p.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"glass-strong rounded-2xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(je,{className:"w-4 h-4"}),e.jsxs("span",{className:"text-sm font-medium",children:[t||"Unknown"," ",a&&a!=="unknown"?a:""]})]}),i&&i!=="none"&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(we,{className:"w-3 h-3"}),e.jsx("span",{className:"capitalize",children:i})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(le,{className:"w-4 h-4 text-primary shrink-0"}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:s.map((m,l)=>e.jsx(p.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},transition:{delay:l*.05},children:e.jsx(be,{chord:m,size:"md",keySignature:t})},l))})]}),h&&e.jsx("p",{className:"text-xs text-muted-foreground leading-relaxed pt-1 border-t border-border/50",children:h}),d!==void 0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 h-1 bg-muted rounded-full overflow-hidden",children:e.jsx(p.div,{initial:{width:0},animate:{width:`${d*100}%`},transition:{delay:.3,duration:.5},className:"h-full bg-gradient-to-r from-primary to-accent rounded-full"})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[Math.round(d*100),"%"]})]})]})}function X(s,t,a,i){const h=(a-s)*Math.PI/180,m=(i-t)*Math.PI/180,l=Math.sin(h/2)*Math.sin(h/2)+Math.cos(s*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(m/2)*Math.sin(m/2);return 6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))}function re(){const{user:s}=P(),t=typeof window<"u"&&window.location.hostname.endsWith("github.io");return V({queryKey:["user-location",s==null?void 0:s.id],queryFn:async()=>{if(!s||t)return null;const{data:a,error:i}=await C.from("user_locations").select("*").eq("user_id",s.id).maybeSingle();if(i)throw i;return a},enabled:!!s&&!t})}function Xe(){const s=Z(),{user:t}=P();return F({mutationFn:async({latitude:a,longitude:i,sharingEnabled:d=!0,radiusKm:h=50})=>{if(!t)throw new Error("Must be logged in");const{data:m,error:l}=await C.from("user_locations").upsert({user_id:t.id,latitude:a,longitude:i,sharing_enabled:d,radius_km:h}).select().single();if(l)throw l;return m},onSuccess:()=>{s.invalidateQueries({queryKey:["user-location"]}),s.invalidateQueries({queryKey:["nearby-listeners"]})}})}function Ze(){const s=Z(),{user:t}=P();return F({mutationFn:async()=>{if(!t)throw new Error("Must be logged in");const{error:a}=await C.from("user_locations").update({sharing_enabled:!1}).eq("user_id",t.id);if(a)throw a},onSuccess:()=>{s.invalidateQueries({queryKey:["user-location"]})}})}function Ge(s,t){const{user:a}=P(),{data:i}=re();return V({queryKey:["nearby-listeners",s,t,i==null?void 0:i.latitude,i==null?void 0:i.longitude],queryFn:async()=>{if(!a||!(i!=null&&i.sharing_enabled))return[];const{data:d,error:h}=await C.from("user_locations").select("user_id, latitude_fuzzy, longitude_fuzzy").eq("sharing_enabled",!0).neq("user_id",a.id);if(h)throw h;const m=(d||[]).filter(r=>X(i.latitude,i.longitude,Number(r.latitude_fuzzy),Number(r.longitude_fuzzy))<=i.radius_km).map(r=>({user_id:r.user_id,distance_km:X(i.latitude,i.longitude,Number(r.latitude_fuzzy),Number(r.longitude_fuzzy))}));if(m.length===0)return[];const{data:l,error:u}=await C.from("profiles").select("id, display_name, avatar_url").in("id",m.map(r=>r.user_id));if(u)throw u;let b=[];if(s||t){let r=C.from("nearby_activity").select("*").in("user_id",m.map(n=>n.user_id)).order("listened_at",{ascending:!1});if(s&&(r=r.eq("track_id",s)),t){const n=t.replace(/[%_]/g,"\\$&");r=r.ilike("artist",`%${n}%`)}const{data:o}=await r;b=o||[]}return m.map(({user_id:r,distance_km:o})=>{const n=(l||[]).find(j=>j.id===r),f=b.find(j=>j.user_id===r);return{user_id:r,display_name:(n==null?void 0:n.display_name)||"Anonymous",avatar_url:n==null?void 0:n.avatar_url,distance_km:Math.round(o*10)/10,last_track:f==null?void 0:f.track_id,last_artist:f==null?void 0:f.artist,listened_at:f==null?void 0:f.listened_at}}).filter(r=>!s&&!t?!0:b.some(o=>o.user_id===r.user_id)).sort((r,o)=>r.distance_km-o.distance_km)},enabled:!!a&&!!(i!=null&&i.sharing_enabled)})}function Je(){const{user:s}=P();return F({mutationFn:async({trackId:t,artist:a})=>{if(!s)return;const{error:i}=await C.from("nearby_activity").insert({user_id:s.id,track_id:t,artist:a||null});if(i)throw i}})}function es({trackId:s,artist:t,trackTitle:a}){const[i,d]=y.useState(!1),[h,m]=y.useState(!1),[l,u]=y.useState(50),[b,v]=y.useState(!1),{user:r}=P(),o=G(),{data:n,isLoading:f}=re(),{data:j=[],isLoading:g}=Ge(s,t),w=Xe(),N=Ze();y.useEffect(()=>{n!=null&&n.radius_km&&u(n.radius_km)},[n==null?void 0:n.radius_km]);const M=async()=>{if(!r){o("/auth");return}v(!0);try{const c=await new Promise((_,A)=>{navigator.geolocation.getCurrentPosition(_,A,{enableHighAccuracy:!1,timeout:1e4,maximumAge:3e5})});await w.mutateAsync({latitude:c.coords.latitude,longitude:c.coords.longitude,sharingEnabled:!0,radiusKm:l})}catch(c){console.error("Location error:",c)}finally{v(!1)}},I=async c=>{const _=c[0];u(_),n&&await w.mutateAsync({latitude:n.latitude,longitude:n.longitude,sharingEnabled:!0,radiusKm:_})},L=async c=>{c&&!n?await M():c?n&&await w.mutateAsync({latitude:n.latitude,longitude:n.longitude,sharingEnabled:c,radiusKm:l}):await N.mutateAsync()},T=(n==null?void 0:n.sharing_enabled)??!1;return e.jsxs(J,{open:i,onOpenChange:d,children:[e.jsx(ee,{asChild:!0,children:e.jsxs(p.button,{whileTap:{scale:.9},className:"flex flex-col items-center gap-1 p-3 rounded-xl transition-all text-muted-foreground hover:text-foreground",children:[e.jsxs("div",{className:"p-3 rounded-full bg-muted/50 hover:bg-muted transition-all relative",children:[e.jsx(U,{className:"w-6 h-6"}),T&&j.length>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-accent text-accent-foreground text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center",children:j.length})]}),e.jsx("span",{className:"text-xs font-medium",children:"Nearby"})]})}),e.jsxs(se,{side:"bottom",className:"h-[80vh] rounded-t-3xl",children:[e.jsx(te,{className:"pb-4 border-b border-border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(U,{className:"w-5 h-5 text-accent"}),a?`Listeners of "${a}"`:"Nearby Music Lovers"]}),e.jsx(S,{variant:"ghost",size:"icon",onClick:()=>m(!h),className:"h-8 w-8",children:e.jsx(Be,{className:"w-4 h-4"})})]})}),e.jsx(O,{children:h&&e.jsx(p.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"overflow-hidden border-b border-border",children:e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{className:"w-4 h-4 text-primary"}),e.jsx(W,{htmlFor:"location-sharing",children:"Share my location"})]}),e.jsx(Me,{id:"location-sharing",checked:T,onCheckedChange:L,disabled:w.isPending||N.isPending})]}),T&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(W,{children:"Discovery radius"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[l," km"]})]}),e.jsx(Pe,{value:[l],onValueChange:I,min:5,max:100,step:5,className:"w-full"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Your location is only visible to others who also share theirs."})]})})}),e.jsx("div",{className:"flex flex-col h-[calc(80vh-10rem)]",children:e.jsx(de,{className:"flex-1 py-4",children:r?T?g||f?e.jsx("div",{className:"space-y-4",children:[1,2,3].map(c=>e.jsxs("div",{className:"flex gap-3 animate-pulse",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-muted"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 w-32 bg-muted rounded"}),e.jsx("div",{className:"h-3 w-24 bg-muted rounded"})]})]},c))}):j.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(Ae,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No listeners nearby yet"}),e.jsx("p",{className:"text-sm",children:"Check back later or expand your radius"})]}):e.jsx(O,{mode:"popLayout",children:j.map((c,_)=>{var A;return e.jsxs(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:_*.05},className:"flex gap-3 mb-4 p-3 rounded-xl glass hover:bg-muted/30 transition-colors",children:[e.jsxs(me,{className:"w-12 h-12",children:[e.jsx(ue,{src:c.avatar_url}),e.jsx(he,{className:"bg-accent/20 text-accent",children:((A=c.display_name)==null?void 0:A.charAt(0).toUpperCase())||"A"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:c.display_name}),e.jsxs("span",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(D,{className:"w-3 h-3"}),c.distance_km," km"]})]}),c.last_artist&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Recently listened to ",c.last_artist]}),c.listened_at&&e.jsx("p",{className:"text-xs text-muted-foreground",children:ke(new Date(c.listened_at),{addSuffix:!0})})]})]},c.user_id)})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(D,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground mb-2",children:"Enable location sharing"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Discover people nearby who love the same music"}),e.jsxs(S,{onClick:M,disabled:b,className:"gap-2",children:[b?e.jsx(ce,{className:"w-4 h-4 animate-spin"}):e.jsx(D,{className:"w-4 h-4"}),"Enable Location"]})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(U,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Sign in to discover nearby listeners"}),e.jsx(S,{onClick:()=>o("/auth"),children:"Sign In"})]})})})]})]})}function ss({track:s,onShare:t}){const[a,i]=y.useState(!1),[d,h]=y.useState(!1),{toast:m}=xe(),l=`${window.location.origin}/track/${s.id}`,u=`Check out "${s.title}" by ${s.artist} on HarmonyFeed! ðŸŽµ`,b=async()=>{try{await navigator.clipboard.writeText(l),h(!0),m({title:"Link copied!"}),setTimeout(()=>h(!1),2e3),t==null||t()}catch{m({title:"Failed to copy",variant:"destructive"})}},v=async()=>{if(navigator.share)try{await navigator.share({title:s.title,text:u,url:l}),t==null||t(),i(!1)}catch{}},r=[{name:"Copy Link",icon:d?Ie:Qe,onClick:b,className:d?"text-green-500":""},{name:"Twitter/X",icon:qe,onClick:()=>{window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(u)}&url=${encodeURIComponent(l)}`,"_blank"),t==null||t()}},{name:"WhatsApp",icon:ze,onClick:()=>{window.open(`https://wa.me/?text=${encodeURIComponent(u+" "+l)}`,"_blank"),t==null||t()}},{name:"Telegram",icon:$e,onClick:()=>{window.open(`https://t.me/share/url?url=${encodeURIComponent(l)}&text=${encodeURIComponent(u)}`,"_blank"),t==null||t()}}];return e.jsxs(J,{open:a,onOpenChange:i,children:[e.jsx(ee,{asChild:!0,children:e.jsxs(S,{variant:"ghost",size:"sm",className:"text-muted-foreground hover:text-foreground gap-2",children:[e.jsx(E,{className:"w-4 h-4"}),"Share"]})}),e.jsxs(se,{side:"bottom",className:"rounded-t-3xl",children:[e.jsx(te,{className:"pb-4",children:e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-5 h-5 text-primary"}),'Share "',s.title,'"']})}),e.jsxs("div",{className:"space-y-4 pb-8",children:[e.jsxs("div",{className:"flex gap-3 p-3 rounded-xl glass",children:[s.cover_url?e.jsx("img",{src:s.cover_url,alt:"",className:"w-16 h-16 rounded-lg object-cover"}):e.jsx("div",{className:"w-16 h-16 rounded-lg bg-muted flex items-center justify-center",children:e.jsx(ne,{className:"w-6 h-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium truncate",children:s.title}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.artist})]})]}),typeof navigator<"u"&&"share"in navigator&&e.jsxs(S,{onClick:v,className:"w-full gap-2",variant:"default",children:[e.jsx(E,{className:"w-4 h-4"}),"Share"]}),e.jsx("div",{className:"grid grid-cols-4 gap-3",children:r.map(o=>e.jsxs(p.button,{whileTap:{scale:.95},onClick:o.onClick,className:"flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-muted/50 transition-colors",children:[e.jsx("div",{className:`p-3 rounded-full bg-muted ${o.className||""}`,children:e.jsx(o.icon,{className:"w-5 h-5"})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:o.name})]},o.name))})]})]})]})}const ts={intro:"bg-blue-500/20 text-blue-300 border-blue-500/30",verse:"bg-purple-500/20 text-purple-300 border-purple-500/30","pre-chorus":"bg-pink-500/20 text-pink-300 border-pink-500/30",chorus:"bg-green-500/20 text-green-300 border-green-500/30",bridge:"bg-orange-500/20 text-orange-300 border-orange-500/30",outro:"bg-red-500/20 text-red-300 border-red-500/30",breakdown:"bg-yellow-500/20 text-yellow-300 border-yellow-500/30",drop:"bg-cyan-500/20 text-cyan-300 border-cyan-500/30"};function as({sections:s,youtubeId:t,spotifyId:a,trackTitle:i,trackArtist:d,canonicalTrackId:h=null,className:m}){const{openPlayer:l,seekTo:u,youtubeOpen:b,youtubeTrackId:v,spotifyOpen:r,spotifyTrackId:o,currentSectionId:n,positionMs:f}=K(),j=g=>{const w=Math.floor(g.start_ms/1e3),N=b&&(v==null?void 0:v.includes(t||""));t?N?u(w):l({canonicalTrackId:null,provider:"youtube",providerTrackId:t,autoplay:!0,startSec:w}):a&&!(r&&o===a)&&l({canonicalTrackId:null,provider:"spotify",providerTrackId:a,autoplay:!0})};return!s||s.length===0?null:e.jsx("div",{className:$("flex gap-1.5 flex-wrap",m),children:s.map((g,w)=>{const N=ts[g.label]||"bg-muted/20 text-muted-foreground border-muted/30",M=w===s.length-1,I=n===g.id||n===null&&f>=g.start_ms&&(M?f<=g.end_ms:f<g.end_ms);return e.jsx(p.button,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{delay:w*.03},onClick:()=>j(g),className:$("group relative px-2 py-1 rounded-md text-xs font-medium","border transition-all hover:scale-105",I&&"ring-2 ring-primary ring-offset-1",N),title:`Play from ${g.label} at ${Y(g.start_ms)}`,children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ie,{className:"w-2.5 h-2.5 opacity-0 group-hover:opacity-100 transition-opacity"}),e.jsx("span",{className:"capitalize",children:g.label}),e.jsx("span",{className:"text-[10px] opacity-60",children:Y(g.start_ms)})]})},g.id)})})}function is({track:s}){const t=G(),{enqueueNext:a,enqueueLater:i}=K(),d=()=>{s.album&&t(`/album/${encodeURIComponent(s.album)}`)},h=()=>{s.artist&&t(`/artist/${encodeURIComponent(s.artist)}`)},m=()=>{if(s.progression_roman){const u=s.progression_roman.join("-");t(`/search?mode=chord&q=${encodeURIComponent(u)}`)}},l=()=>{t(`/connections/${encodeURIComponent(s.id)}`)};return e.jsxs(ve,{children:[e.jsx(Ne,{asChild:!0,children:e.jsx(S,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:u=>u.stopPropagation(),children:e.jsx(_e,{className:"w-4 h-4"})})}),e.jsxs(Ce,{align:"end",className:"w-56",children:[e.jsxs(k,{onClick:()=>a(s),children:[e.jsx(He,{className:"w-4 h-4 mr-2"}),"Play Next"]}),e.jsxs(k,{onClick:()=>i(s),children:[e.jsx(pe,{className:"w-4 h-4 mr-2"}),"Add to Queue"]}),e.jsx(H,{}),s.album&&e.jsxs(k,{onClick:d,children:[e.jsx(Ke,{className:"w-4 h-4 mr-2"}),"View Album"]}),s.artist&&e.jsxs(k,{onClick:h,children:[e.jsx(Re,{className:"w-4 h-4 mr-2"}),"View Artist"]}),e.jsx(H,{}),s.progression_roman&&s.progression_roman.length>0&&e.jsxs(k,{onClick:m,children:[e.jsx(De,{className:"w-4 h-4 mr-2"}),"Similar Chord Progressions"]}),e.jsxs(k,{onClick:l,children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"View Samples & Connections"]})]})]})}function ns(s){return V({queryKey:["track-comments",s],queryFn:async()=>{try{const{data:t,error:a}=await C.from("track_comments").select("*").eq("track_id",s).order("created_at",{ascending:!0});return a?(console.warn("[Comments] track_comments fetch skipped due to schema error",a),[]):(t||[]).map(i=>({...i,user_display_name:"Anonymous",user_avatar_url:void 0}))}catch(t){return console.error("Failed to load track comments:",t),[]}},enabled:!!s})}function Is({track:s,isActive:t,onInteraction:a,interactions:i=new Set,onPipModeActivate:d,isPipActive:h=!1}){const{user:m,guestMode:l}=P(),[u,b]=y.useState(!1),[v,r]=y.useState(!1),o=y.useRef(null),n=y.useRef(null),f=Je(),j=Te(),{openPlayer:g}=K(),{data:w}=ns(s.id),N=(w==null?void 0:w.length)||0,M=y.useCallback(x=>x.map((q,Q)=>{var B;return{id:`${s.id}-${q.type}-${Q}`,track_id:s.id,label:q.type,start_ms:q.start_time*1e3,end_ms:q.end_time?q.end_time*1e3:(((B=x[Q+1])==null?void 0:B.start_time)||s.duration_ms||24e4/1e3)*1e3,created_at:new Date().toISOString()}}),[s.id,s.duration_ms]),I=y.useCallback(()=>{const x=s.duration_ms||24e4;return[{id:`${s.id}-intro`,track_id:s.id,label:"intro",start_ms:0,end_ms:Math.floor(x*.1),created_at:new Date().toISOString()},{id:`${s.id}-verse1`,track_id:s.id,label:"verse",start_ms:Math.floor(x*.1),end_ms:Math.floor(x*.3),created_at:new Date().toISOString()},{id:`${s.id}-chorus1`,track_id:s.id,label:"chorus",start_ms:Math.floor(x*.3),end_ms:Math.floor(x*.5),created_at:new Date().toISOString()},{id:`${s.id}-verse2`,track_id:s.id,label:"verse",start_ms:Math.floor(x*.5),end_ms:Math.floor(x*.65),created_at:new Date().toISOString()},{id:`${s.id}-chorus2`,track_id:s.id,label:"chorus",start_ms:Math.floor(x*.65),end_ms:Math.floor(x*.85),created_at:new Date().toISOString()},{id:`${s.id}-outro`,track_id:s.id,label:"outro",start_ms:Math.floor(x*.85),end_ms:x,created_at:new Date().toISOString()}]},[s.id,s.duration_ms]),L=s.sections&&s.sections.length>0?M(s.sections):I();y.useEffect(()=>{!t&&u&&c()},[t]),y.useEffect(()=>()=>{o.current&&o.current.pause()},[]);const T=y.useCallback(async()=>{if(o.current&&s.preview_url)try{await o.current.play(),b(!0),n.current=Date.now(),f.mutate({trackId:s.id,artist:s.artist})}catch(x){console.error("Playback failed:",x)}},[s.preview_url,s.id,s.artist,f]),c=y.useCallback(()=>{if(o.current&&(o.current.pause(),b(!1),n.current&&m)){const x=Date.now()-n.current;j.mutate({trackId:s.id,durationMs:x,source:"feed"}),n.current=null}},[m,s.id,j]),_=()=>{u?c():T()},A=()=>{if(b(!1),n.current&&m){const x=Date.now()-n.current;j.mutate({trackId:s.id,durationMs:x,source:"feed"}),n.current=null}},oe=()=>{a("share")};return e.jsxs(p.div,{initial:{opacity:0},animate:{opacity:t?1:.5},className:"relative w-full h-full flex flex-col","data-track-card":s.id,children:[s.preview_url&&e.jsx("audio",{ref:o,src:s.preview_url,preload:"none",onEnded:A}),e.jsx("div",{className:"absolute inset-0 z-0",children:s.cover_url?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:s.cover_url,alt:"",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background via-background/80 to-background/40"})]}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-secondary to-background"})}),e.jsxs("div",{className:"relative z-10 flex-1 flex flex-col justify-end p-6 pb-8 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs(p.h2,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},className:"text-2xl font-bold text-foreground line-clamp-2 flex-1 flex items-center gap-2",children:[e.jsx("span",{children:s.title}),s.is_common_ancestor&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-gradient-to-r from-amber-500/20 to-orange-500/20 border border-amber-500/30",title:"Common Ancestor - Foundational track that influenced a musical movement",children:[e.jsx(Le,{size:14,className:"text-amber-400"}),e.jsx("span",{className:"text-[10px] font-semibold text-amber-400 uppercase tracking-wide",children:"Ancestor"})]})]}),e.jsx(is,{track:s})]}),e.jsx(p.p,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.05},className:"text-lg text-muted-foreground",children:s.artist}),(s.tempo||s.genre)&&e.jsxs(p.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.07},className:"flex items-center gap-2 text-sm text-muted-foreground",children:[s.tempo&&e.jsxs("span",{className:"font-medium",children:[Math.round(s.tempo)," BPM"]}),s.tempo&&s.genre&&e.jsx("span",{children:"â€¢"}),s.genre&&e.jsx("span",{className:"capitalize",children:s.genre})]})]}),e.jsx(p.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.08},children:e.jsx(as,{sections:L,youtubeId:s.youtube_id,spotifyId:s.spotify_id,trackTitle:s.title,trackArtist:s.artist||"",canonicalTrackId:s.id})}),e.jsxs(p.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.1},className:"flex items-center gap-3",children:[s.preview_url&&e.jsxs(S,{variant:"outline",size:"lg",onClick:_,className:"gap-2 glass border-white/20 hover:bg-white/10",children:[u?e.jsx(fe,{className:"w-5 h-5"}):e.jsx(ie,{className:"w-5 h-5"}),u?"Pause":"Preview"]}),s.youtube_id&&e.jsxs(S,{variant:"outline",size:"lg",onClick:()=>g({canonicalTrackId:s.id,provider:"youtube",providerTrackId:s.youtube_id,autoplay:!0,context:"feed-card-watch",title:s.title,artist:s.artist}),className:"gap-2 glass border-white/20 hover:bg-white/10",children:[e.jsx(We,{className:"w-5 h-5"}),"Watch"]}),e.jsx(ge,{track:{spotifyId:s.spotify_id||void 0,youtubeId:s.youtube_id||void 0,urlSpotifyWeb:s.url_spotify_web||void 0,urlSpotifyApp:s.url_spotify_app||void 0,urlYoutube:s.url_youtube||void 0},canonicalTrackId:s.id,trackTitle:s.title,trackArtist:s.artist,size:"md"})]}),s.progression_roman&&s.progression_roman.length>0&&e.jsx(p.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.15},children:e.jsx(Ye,{progression:s.progression_roman,detectedKey:s.detected_key,detectedMode:s.detected_mode,cadenceType:s.cadence_type,confidenceScore:s.confidence_score,matchReason:"Same viâ€“IVâ€“Iâ€“V loop with similar energy"})}),e.jsxs(p.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},className:"flex items-center justify-between pt-4 relative z-20",children:[e.jsx(z,{icon:ye,label:"Skip",isActive:i.has("skip"),onClick:()=>a("skip"),variant:"muted"}),e.jsx(z,{icon:Ue,label:"Harmonic",isActive:i.has("more_harmonic"),onClick:()=>a("more_harmonic"),variant:"primary"}),e.jsx(z,{icon:Ee,label:"Like",isActive:i.has("like"),onClick:()=>a("like"),variant:"accent"}),e.jsx(z,{icon:Oe,label:"Vibe",isActive:i.has("more_vibe"),onClick:()=>a("more_vibe"),variant:"primary"}),e.jsx(z,{icon:Fe,label:"Save",isActive:i.has("save"),onClick:()=>a("save"),variant:"muted"})]}),e.jsxs(p.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.25},className:"flex items-center justify-center gap-4",children:[e.jsxs(p.button,{whileTap:{scale:.9},onClick:()=>r(!v),className:"flex items-center gap-2 px-4 py-2 rounded-full bg-muted/50 hover:bg-muted transition-all text-muted-foreground hover:text-foreground",children:[e.jsx(Ve,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium",children:N})]}),e.jsx(es,{trackId:s.id,artist:s.artist,trackTitle:s.title}),e.jsx(ss,{track:s,onShare:oe})]}),e.jsx(O,{children:v&&e.jsx(p.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.3},className:"overflow-hidden",children:e.jsx("div",{className:"mt-6 pt-6 border-t border-border/50",children:e.jsx(Se,{trackId:s.id})})})})]})]})}function z({icon:s,label:t,isActive:a,onClick:i,variant:d}){return e.jsxs(p.button,{whileTap:{scale:.9},onClick:i,className:$("flex flex-col items-center gap-1 p-3 rounded-xl transition-all",a&&d==="accent"&&"text-accent glow-accent",a&&d==="primary"&&"text-primary glow-primary",a&&d==="muted"&&"text-foreground",!a&&"text-muted-foreground hover:text-foreground"),children:[e.jsx("div",{className:$("p-3 rounded-full transition-all",a&&d==="accent"&&"bg-accent/20",a&&d==="primary"&&"bg-primary/20",a&&d==="muted"&&"bg-muted",!a&&"bg-muted/50 hover:bg-muted"),children:e.jsx(s,{className:$("w-6 h-6",a&&d==="accent"&&"fill-current")})}),e.jsx("span",{className:"text-xs font-medium",children:t})]})}export{Is as T};
