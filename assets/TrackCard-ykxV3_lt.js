import{c as I,j as e,m as h,M as ce,q as de,a as M,D as K,w as N,v as O,z as J,r as y,u as G,aY as ee,aZ as se,a_ as te,a$ as ae,b0 as ie,B as _,J as me,h as ue,$ as xe,a0 as he,a1 as pe,E as fe,e as Q,x as R,P as ne,b1 as ye,av as ge,Q as be,X as je,S as we}from"./index-BwokqWUm.js";import{K as ve,R as Ne}from"./rotate-ccw-BOzLRPCB.js";import{D as _e,a as Ce,E as Se,b as Me,c as P,d as W,T as ke}from"./TrackComments-CKZjgr3O.js";import{S as Pe}from"./switch-DfBn8-gu.js";import{S as Te,b as Ae}from"./useFollowing-BxzVIyOB.js";import{L as Y}from"./label-KslxRO6v.js";import{U as D}from"./users-Dwp3D-hG.js";import{A as V}from"./index-DDWLPyMc.js";import{M as $}from"./map-pin-B1dvg4dx.js";import{R as qe}from"./radio-DRwUI9lc.js";import{f as ze}from"./formatDistanceToNow-3UBXKcFR.js";import{S as F}from"./share-2-D1rKDAXO.js";import{L as re}from"./BottomNav-B5kOPxuM.js";import{C as Re}from"./check-T5eEYh5j.js";import{T as Ie}from"./twitter-PvSeg9gP.js";import{M as $e,S as Le}from"./send-QHp_x90t.js";import{b as X}from"./timeFormat-1gw3rh39.js";import{U as Ee}from"./user-ocqv7jmx.js";import{M as Ue}from"./music-2-ClNhJJUA.js";import{A as De}from"./ProfileCircle-dNBGVNsB.js";import{H as Fe}from"./heart-B5jS5Sbs.js";import{W as Ve}from"./waves-Cd_9SXRq.js";import{B as Ke}from"./bookmark-BDeigjHr.js";import{M as Oe}from"./search-B_zF9Xl2.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=I("Album",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["polyline",{points:"11 3 11 11 14 8 17 11 17 3",key:"1wcwz3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=I("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=I("Settings2",[["path",{d:"M20 7h-9",key:"3s1dr2"}],["path",{d:"M14 17H5",key:"gfn3mx"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=I("SquarePlay",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"m9 8 6 4-6 4Z",key:"f1r3lt"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=I("Youtube",[["path",{d:"M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 1.4-1.4 49.56 49.56 0 0 1 16.2 0A2 2 0 0 1 21.5 7a24.12 24.12 0 0 1 0 10 2 2 0 0 1-1.4 1.4 49.55 49.55 0 0 1-16.2 0A2 2 0 0 1 2.5 17",key:"1q2vi4"}],["path",{d:"m10 15 5-3-5-3z",key:"1jp15x"}]]);function Xe({progression:s,detectedKey:t,detectedMode:i,cadenceType:a,confidenceScore:l,matchReason:u}){return e.jsxs(h.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"glass-strong rounded-2xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(ve,{className:"w-4 h-4"}),e.jsxs("span",{className:"text-sm font-medium",children:[t||"Unknown"," ",i&&i!=="unknown"?i:""]})]}),a&&a!=="none"&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(Ne,{className:"w-3 h-3"}),e.jsx("span",{className:"capitalize",children:a})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(ce,{className:"w-4 h-4 text-primary shrink-0"}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:s.map((d,c)=>e.jsx(h.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},transition:{delay:c*.05},children:e.jsx(de,{chord:d,size:"md",keySignature:t})},c))})]}),u&&e.jsx("p",{className:"text-xs text-muted-foreground leading-relaxed pt-1 border-t border-border/50",children:u}),l!==void 0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 h-1 bg-muted rounded-full overflow-hidden",children:e.jsx(h.div,{initial:{width:0},animate:{width:`${l*100}%`},transition:{delay:.3,duration:.5},className:"h-full bg-gradient-to-r from-primary to-accent rounded-full"})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[Math.round(l*100),"%"]})]})]})}function Z(s,t,i,a){const u=(i-s)*Math.PI/180,d=(a-t)*Math.PI/180,c=Math.sin(u/2)*Math.sin(u/2)+Math.cos(s*Math.PI/180)*Math.cos(i*Math.PI/180)*Math.sin(d/2)*Math.sin(d/2);return 6371*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))}function oe(){const{user:s}=M(),t=typeof window<"u"&&window.location.hostname.endsWith("github.io");return O({queryKey:["user-location",s==null?void 0:s.id],queryFn:async()=>{if(!s||t)return null;const{data:i,error:a}=await N.from("user_locations").select("*").eq("user_id",s.id).maybeSingle();if(a)throw a;return i},enabled:!!s&&!t})}function Ze(){const s=J(),{user:t}=M();return K({mutationFn:async({latitude:i,longitude:a,sharingEnabled:l=!0,radiusKm:u=50})=>{if(!t)throw new Error("Must be logged in");const{data:d,error:c}=await N.from("user_locations").upsert({user_id:t.id,latitude:i,longitude:a,sharing_enabled:l,radius_km:u}).select().single();if(c)throw c;return d},onSuccess:()=>{s.invalidateQueries({queryKey:["user-location"]}),s.invalidateQueries({queryKey:["nearby-listeners"]})}})}function Je(){const s=J(),{user:t}=M();return K({mutationFn:async()=>{if(!t)throw new Error("Must be logged in");const{error:i}=await N.from("user_locations").update({sharing_enabled:!1}).eq("user_id",t.id);if(i)throw i},onSuccess:()=>{s.invalidateQueries({queryKey:["user-location"]})}})}function Ge(s,t){const{user:i}=M(),{data:a}=oe();return O({queryKey:["nearby-listeners",s,t,a==null?void 0:a.latitude,a==null?void 0:a.longitude],queryFn:async()=>{if(!i||!(a!=null&&a.sharing_enabled))return[];const{data:l,error:u}=await N.from("user_locations").select("user_id, latitude_fuzzy, longitude_fuzzy").eq("sharing_enabled",!0).neq("user_id",i.id);if(u)throw u;const d=(l||[]).filter(r=>Z(a.latitude,a.longitude,Number(r.latitude_fuzzy),Number(r.longitude_fuzzy))<=a.radius_km).map(r=>({user_id:r.user_id,distance_km:Z(a.latitude,a.longitude,Number(r.latitude_fuzzy),Number(r.longitude_fuzzy))}));if(d.length===0)return[];const{data:c,error:x}=await N.from("profiles").select("id, display_name, avatar_url").in("id",d.map(r=>r.user_id));if(x)throw x;let g=[];if(s||t){let r=N.from("nearby_activity").select("*").in("user_id",d.map(n=>n.user_id)).order("listened_at",{ascending:!1});if(s&&(r=r.eq("track_id",s)),t){const n=t.replace(/[%_]/g,"\\$&");r=r.ilike("artist",`%${n}%`)}const{data:o}=await r;g=o||[]}return d.map(({user_id:r,distance_km:o})=>{const n=(c||[]).find(f=>f.id===r),p=g.find(f=>f.user_id===r);return{user_id:r,display_name:(n==null?void 0:n.display_name)||"Anonymous",avatar_url:n==null?void 0:n.avatar_url,distance_km:Math.round(o*10)/10,last_track:p==null?void 0:p.track_id,last_artist:p==null?void 0:p.artist,listened_at:p==null?void 0:p.listened_at}}).filter(r=>!s&&!t?!0:g.some(o=>o.user_id===r.user_id)).sort((r,o)=>r.distance_km-o.distance_km)},enabled:!!i&&!!(a!=null&&a.sharing_enabled)})}function es(){const{user:s}=M();return K({mutationFn:async({trackId:t,artist:i})=>{if(!s)return;const{error:a}=await N.from("nearby_activity").insert({user_id:s.id,track_id:t,artist:i||null});if(a)throw a}})}function ss({trackId:s,artist:t,trackTitle:i}){const[a,l]=y.useState(!1),[u,d]=y.useState(!1),[c,x]=y.useState(50),[g,b]=y.useState(!1),{user:r}=M(),o=G(),{data:n,isLoading:p}=oe(),{data:f=[],isLoading:C}=Ge(s,t),j=Ze(),T=Je();y.useEffect(()=>{n!=null&&n.radius_km&&x(n.radius_km)},[n==null?void 0:n.radius_km]);const A=async()=>{if(!r){o("/auth");return}b(!0);try{const m=await new Promise((v,k)=>{navigator.geolocation.getCurrentPosition(v,k,{enableHighAccuracy:!1,timeout:1e4,maximumAge:3e5})});await j.mutateAsync({latitude:m.coords.latitude,longitude:m.coords.longitude,sharingEnabled:!0,radiusKm:c})}catch(m){console.error("Location error:",m)}finally{b(!1)}},L=async m=>{const v=m[0];x(v),n&&await j.mutateAsync({latitude:n.latitude,longitude:n.longitude,sharingEnabled:!0,radiusKm:v})},E=async m=>{m&&!n?await A():m?n&&await j.mutateAsync({latitude:n.latitude,longitude:n.longitude,sharingEnabled:m,radiusKm:c}):await T.mutateAsync()},S=(n==null?void 0:n.sharing_enabled)??!1;return e.jsxs(ee,{open:a,onOpenChange:l,children:[e.jsx(se,{asChild:!0,children:e.jsxs(h.button,{whileTap:{scale:.9},className:"flex flex-col items-center gap-1 p-3 rounded-xl transition-all text-muted-foreground hover:text-foreground",children:[e.jsxs("div",{className:"p-3 rounded-full bg-muted/50 hover:bg-muted transition-all relative",children:[e.jsx(D,{className:"w-6 h-6"}),S&&f.length>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-accent text-accent-foreground text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center",children:f.length})]}),e.jsx("span",{className:"text-xs font-medium",children:"Nearby"})]})}),e.jsxs(te,{side:"bottom",className:"h-[80vh] rounded-t-3xl",children:[e.jsx(ae,{className:"pb-4 border-b border-border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ie,{className:"flex items-center gap-2",children:[e.jsx(D,{className:"w-5 h-5 text-accent"}),i?`Listeners of "${i}"`:"Nearby Music Lovers"]}),e.jsx(_,{variant:"ghost",size:"icon",onClick:()=>d(!u),className:"h-8 w-8",children:e.jsx(He,{className:"w-4 h-4"})})]})}),e.jsx(V,{children:u&&e.jsx(h.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"overflow-hidden border-b border-border",children:e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($,{className:"w-4 h-4 text-primary"}),e.jsx(Y,{htmlFor:"location-sharing",children:"Share my location"})]}),e.jsx(Pe,{id:"location-sharing",checked:S,onCheckedChange:E,disabled:j.isPending||T.isPending})]}),S&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Y,{children:"Discovery radius"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[c," km"]})]}),e.jsx(Te,{value:[c],onValueChange:L,min:5,max:100,step:5,className:"w-full"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Your location is only visible to others who also share theirs."})]})})}),e.jsx("div",{className:"flex flex-col h-[calc(80vh-10rem)]",children:e.jsx(me,{className:"flex-1 py-4",children:r?S?C||p?e.jsx("div",{className:"space-y-4",children:[1,2,3].map(m=>e.jsxs("div",{className:"flex gap-3 animate-pulse",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-muted"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 w-32 bg-muted rounded"}),e.jsx("div",{className:"h-3 w-24 bg-muted rounded"})]})]},m))}):f.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(qe,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No listeners nearby yet"}),e.jsx("p",{className:"text-sm",children:"Check back later or expand your radius"})]}):e.jsx(V,{mode:"popLayout",children:f.map((m,v)=>{var k;return e.jsxs(h.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:v*.05},className:"flex gap-3 mb-4 p-3 rounded-xl glass hover:bg-muted/30 transition-colors",children:[e.jsxs(xe,{className:"w-12 h-12",children:[e.jsx(he,{src:m.avatar_url}),e.jsx(pe,{className:"bg-accent/20 text-accent",children:((k=m.display_name)==null?void 0:k.charAt(0).toUpperCase())||"A"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:m.display_name}),e.jsxs("span",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx($,{className:"w-3 h-3"}),m.distance_km," km"]})]}),m.last_artist&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Recently listened to ",m.last_artist]}),m.listened_at&&e.jsx("p",{className:"text-xs text-muted-foreground",children:ze(new Date(m.listened_at),{addSuffix:!0})})]})]},m.user_id)})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx($,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground mb-2",children:"Enable location sharing"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Discover people nearby who love the same music"}),e.jsxs(_,{onClick:A,disabled:g,className:"gap-2",children:[g?e.jsx(ue,{className:"w-4 h-4 animate-spin"}):e.jsx($,{className:"w-4 h-4"}),"Enable Location"]})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(D,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Sign in to discover nearby listeners"}),e.jsx(_,{onClick:()=>o("/auth"),children:"Sign In"})]})})})]})]})}function ts({track:s,onShare:t}){const[i,a]=y.useState(!1),[l,u]=y.useState(!1),{toast:d}=fe(),c=`${window.location.origin}/track/${s.id}`,x=`Check out "${s.title}" by ${s.artist} on HarmonyFeed! ðŸŽµ`,g=async()=>{try{await navigator.clipboard.writeText(c),u(!0),d({title:"Link copied!"}),setTimeout(()=>u(!1),2e3),t==null||t()}catch{d({title:"Failed to copy",variant:"destructive"})}},b=async()=>{if(navigator.share)try{await navigator.share({title:s.title,text:x,url:c}),t==null||t(),a(!1)}catch{}},r=[{name:"Copy Link",icon:l?Re:Be,onClick:g,className:l?"text-green-500":""},{name:"Twitter/X",icon:Ie,onClick:()=>{window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(x)}&url=${encodeURIComponent(c)}`,"_blank"),t==null||t()}},{name:"WhatsApp",icon:$e,onClick:()=>{window.open(`https://wa.me/?text=${encodeURIComponent(x+" "+c)}`,"_blank"),t==null||t()}},{name:"Telegram",icon:Le,onClick:()=>{window.open(`https://t.me/share/url?url=${encodeURIComponent(c)}&text=${encodeURIComponent(x)}`,"_blank"),t==null||t()}}];return e.jsxs(ee,{open:i,onOpenChange:a,children:[e.jsx(se,{asChild:!0,children:e.jsxs(_,{variant:"ghost",size:"sm",className:"text-muted-foreground hover:text-foreground gap-2",children:[e.jsx(F,{className:"w-4 h-4"}),"Share"]})}),e.jsxs(te,{side:"bottom",className:"rounded-t-3xl",children:[e.jsx(ae,{className:"pb-4",children:e.jsxs(ie,{className:"flex items-center gap-2",children:[e.jsx(F,{className:"w-5 h-5 text-primary"}),'Share "',s.title,'"']})}),e.jsxs("div",{className:"space-y-4 pb-8",children:[e.jsxs("div",{className:"flex gap-3 p-3 rounded-xl glass",children:[s.cover_url?e.jsx("img",{src:s.cover_url,alt:"",className:"w-16 h-16 rounded-lg object-cover"}):e.jsx("div",{className:"w-16 h-16 rounded-lg bg-muted flex items-center justify-center",children:e.jsx(re,{className:"w-6 h-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium truncate",children:s.title}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.artist})]})]}),typeof navigator<"u"&&"share"in navigator&&e.jsxs(_,{onClick:b,className:"w-full gap-2",variant:"default",children:[e.jsx(F,{className:"w-4 h-4"}),"Share"]}),e.jsx("div",{className:"grid grid-cols-4 gap-3",children:r.map(o=>e.jsxs(h.button,{whileTap:{scale:.95},onClick:o.onClick,className:"flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-muted/50 transition-colors",children:[e.jsx("div",{className:`p-3 rounded-full bg-muted ${o.className||""}`,children:e.jsx(o.icon,{className:"w-5 h-5"})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:o.name})]},o.name))})]})]})]})}const as={intro:"bg-blue-500/20 text-blue-300 border-blue-500/30",verse:"bg-purple-500/20 text-purple-300 border-purple-500/30","pre-chorus":"bg-pink-500/20 text-pink-300 border-pink-500/30",chorus:"bg-green-500/20 text-green-300 border-green-500/30",bridge:"bg-orange-500/20 text-orange-300 border-orange-500/30",outro:"bg-red-500/20 text-red-300 border-red-500/30",breakdown:"bg-yellow-500/20 text-yellow-300 border-yellow-500/30",drop:"bg-cyan-500/20 text-cyan-300 border-cyan-500/30"};function is({sections:s,youtubeId:t,spotifyId:i,trackTitle:a,trackArtist:l,canonicalTrackId:u=null,className:d}){const{openPlayer:c,seekTo:x,provider:g,trackId:b,canonicalTrackId:r}=Q(),o=n=>{const p=Math.floor(n.start_ms/1e3),f=t?"youtube":"spotify",C=t??i??null;if(!C)return;if(u&&r===u||g===f&&b===C){x(p);return}c({canonicalTrackId:u,provider:f,providerTrackId:C,autoplay:!0,startSec:p,context:"compact-sections",title:a,artist:l})};return!s||s.length===0?null:e.jsx("div",{className:R("flex gap-1.5 flex-wrap",d),children:s.map((n,p)=>{const f=as[n.label]||"bg-muted/20 text-muted-foreground border-muted/30";return e.jsx(h.button,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{delay:p*.03},onClick:()=>o(n),className:R("group relative px-2 py-1 rounded-md text-xs font-medium","border transition-all hover:scale-105",f),title:`Play from ${n.label} at ${X(n.start_ms)}`,children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ne,{className:"w-2.5 h-2.5 opacity-0 group-hover:opacity-100 transition-opacity"}),e.jsx("span",{className:"capitalize",children:n.label}),e.jsx("span",{className:"text-[10px] opacity-60",children:X(n.start_ms)})]})},n.id)})})}function ns({track:s}){const t=G(),{enqueueNext:i,enqueueLater:a}=Q(),l=()=>{s.album&&t(`/album/${encodeURIComponent(s.album)}`)},u=()=>{s.artist&&t(`/artist/${encodeURIComponent(s.artist)}`)},d=()=>{if(s.progression_roman){const x=s.progression_roman.join("-");t(`/search?mode=chord&q=${encodeURIComponent(x)}`)}},c=()=>{t(`/connections/${encodeURIComponent(s.id)}`)};return e.jsxs(_e,{children:[e.jsx(Ce,{asChild:!0,children:e.jsx(_,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:x=>x.stopPropagation(),children:e.jsx(Se,{className:"w-4 h-4"})})}),e.jsxs(Me,{align:"end",className:"w-56",children:[e.jsxs(P,{onClick:()=>i(s),children:[e.jsx(We,{className:"w-4 h-4 mr-2"}),"Play Next"]}),e.jsxs(P,{onClick:()=>a(s),children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"Add to Queue"]}),e.jsx(W,{}),s.album&&e.jsxs(P,{onClick:l,children:[e.jsx(Qe,{className:"w-4 h-4 mr-2"}),"View Album"]}),s.artist&&e.jsxs(P,{onClick:u,children:[e.jsx(Ee,{className:"w-4 h-4 mr-2"}),"View Artist"]}),e.jsx(W,{}),s.progression_roman&&s.progression_roman.length>0&&e.jsxs(P,{onClick:d,children:[e.jsx(Ue,{className:"w-4 h-4 mr-2"}),"Similar Chord Progressions"]}),e.jsxs(P,{onClick:c,children:[e.jsx(re,{className:"w-4 h-4 mr-2"}),"View Samples & Connections"]})]})]})}function rs(s){return O({queryKey:["track-comments",s],queryFn:async()=>{try{const{data:t,error:i}=await N.from("track_comments").select("*").eq("track_id",s).order("created_at",{ascending:!0});return i?(console.warn("[Comments] track_comments fetch skipped due to schema error",i),[]):(t||[]).map(a=>({...a,user_display_name:"Anonymous",user_avatar_url:void 0}))}catch(t){return console.error("Failed to load track comments:",t),[]}},enabled:!!s})}function As({track:s,isActive:t,onInteraction:i,interactions:a=new Set,onPipModeActivate:l,isPipActive:u=!1}){const{user:d,guestMode:c}=M(),[x,g]=y.useState(!1),[b,r]=y.useState(!1),o=y.useRef(null),n=y.useRef(null),p=es(),f=Ae(),{openPlayer:C}=Q(),{data:j}=rs(s.id),T=(j==null?void 0:j.length)||0,A=y.useCallback(w=>w.map((q,U)=>{var H;const B=q.start_time*1e3,le=typeof q.end_time=="number"?q.end_time*1e3:typeof((H=w[U+1])==null?void 0:H.start_time)=="number"?w[U+1].start_time*1e3:typeof s.duration_ms=="number"?s.duration_ms:24e4;return{id:`${s.id}-${q.type}-${U}`,track_id:s.id,label:q.type,start_ms:B,end_ms:Math.max(le,B+1),created_at:new Date().toISOString()}}),[s.id,s.duration_ms]),L=s.sections&&s.sections.length>0?A(s.sections):[];y.useEffect(()=>{!t&&x&&S()},[t]),y.useEffect(()=>()=>{o.current&&o.current.pause()},[]);const E=y.useCallback(async()=>{if(o.current&&s.preview_url)try{await o.current.play(),g(!0),n.current=Date.now(),p.mutate({trackId:s.id,artist:s.artist})}catch(w){console.error("Playback failed:",w)}},[s.preview_url,s.id,s.artist,p]),S=y.useCallback(()=>{if(o.current&&(o.current.pause(),g(!1),n.current&&d)){const w=Date.now()-n.current;f.mutate({trackId:s.id,durationMs:w,source:"feed"}),n.current=null}},[d,s.id,f]),m=()=>{x?S():E()},v=()=>{if(g(!1),n.current&&d){const w=Date.now()-n.current;f.mutate({trackId:s.id,durationMs:w,source:"feed"}),n.current=null}},k=()=>{i("share")};return e.jsxs(h.div,{initial:{opacity:0},animate:{opacity:t?1:.5},className:"relative w-full h-full flex flex-col","data-track-card":s.id,children:[s.preview_url&&e.jsx("audio",{ref:o,src:s.preview_url,preload:"none",onEnded:v}),e.jsx("div",{className:"absolute inset-0 z-0",children:s.cover_url?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:s.cover_url,alt:"",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background via-background/80 to-background/40"})]}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-secondary to-background"})}),e.jsxs("div",{className:"relative z-10 flex-1 flex flex-col justify-end p-6 pb-8 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs(h.h2,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},className:"text-2xl font-bold text-foreground line-clamp-2 flex-1 flex items-center gap-2",children:[e.jsx("span",{children:s.title}),s.is_common_ancestor&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-gradient-to-r from-amber-500/20 to-orange-500/20 border border-amber-500/30",title:"Common Ancestor - Foundational track that influenced a musical movement",children:[e.jsx(De,{size:14,className:"text-amber-400"}),e.jsx("span",{className:"text-[10px] font-semibold text-amber-400 uppercase tracking-wide",children:"Ancestor"})]})]}),e.jsx(ns,{track:s})]}),e.jsx(h.p,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.05},className:"text-lg text-muted-foreground",children:s.artist}),(s.tempo||s.genre)&&e.jsxs(h.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.07},className:"flex items-center gap-2 text-sm text-muted-foreground",children:[s.tempo&&e.jsxs("span",{className:"font-medium",children:[Math.round(s.tempo)," BPM"]}),s.tempo&&s.genre&&e.jsx("span",{children:"â€¢"}),s.genre&&e.jsx("span",{className:"capitalize",children:s.genre})]})]}),e.jsx(h.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.08},children:e.jsx(is,{sections:L,youtubeId:s.youtube_id,spotifyId:s.spotify_id,trackTitle:s.title,trackArtist:s.artist||"",canonicalTrackId:s.id})}),e.jsxs(h.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.1},className:"flex items-center gap-3",children:[s.preview_url&&e.jsxs(_,{variant:"outline",size:"lg",onClick:m,className:"gap-2 glass border-white/20 hover:bg-white/10",children:[x?e.jsx(ge,{className:"w-5 h-5"}):e.jsx(ne,{className:"w-5 h-5"}),x?"Pause":"Preview"]}),s.youtube_id&&e.jsxs(_,{variant:"outline",size:"lg",onClick:()=>C({canonicalTrackId:s.id,provider:"youtube",providerTrackId:s.youtube_id,autoplay:!0,context:"feed-card-watch",title:s.title,artist:s.artist}),className:"gap-2 glass border-white/20 hover:bg-white/10",children:[e.jsx(Ye,{className:"w-5 h-5"}),"Watch"]}),e.jsx(be,{track:{spotifyId:s.spotify_id||void 0,youtubeId:s.youtube_id||void 0,urlSpotifyWeb:s.url_spotify_web||void 0,urlSpotifyApp:s.url_spotify_app||void 0,urlYoutube:s.url_youtube||void 0},canonicalTrackId:s.id,trackTitle:s.title,trackArtist:s.artist,size:"md"})]}),s.progression_roman&&s.progression_roman.length>0&&e.jsx(h.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.15},children:e.jsx(Xe,{progression:s.progression_roman,detectedKey:s.detected_key,detectedMode:s.detected_mode,cadenceType:s.cadence_type,confidenceScore:s.confidence_score,matchReason:"Same viâ€“IVâ€“Iâ€“V loop with similar energy"})}),e.jsxs(h.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},className:"flex items-center justify-between pt-4 relative z-20",children:[e.jsx(z,{icon:je,label:"Skip",isActive:a.has("skip"),onClick:()=>i("skip"),variant:"muted"}),e.jsx(z,{icon:we,label:"Harmonic",isActive:a.has("more_harmonic"),onClick:()=>i("more_harmonic"),variant:"primary"}),e.jsx(z,{icon:Fe,label:"Like",isActive:a.has("like"),onClick:()=>i("like"),variant:"accent"}),e.jsx(z,{icon:Ve,label:"Vibe",isActive:a.has("more_vibe"),onClick:()=>i("more_vibe"),variant:"primary"}),e.jsx(z,{icon:Ke,label:"Save",isActive:a.has("save"),onClick:()=>i("save"),variant:"muted"})]}),e.jsxs(h.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.25},className:"flex items-center justify-center gap-4",children:[e.jsxs(h.button,{whileTap:{scale:.9},onClick:()=>r(!b),className:"flex items-center gap-2 px-4 py-2 rounded-full bg-muted/50 hover:bg-muted transition-all text-muted-foreground hover:text-foreground",children:[e.jsx(Oe,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium",children:T})]}),e.jsx(ss,{trackId:s.id,artist:s.artist,trackTitle:s.title}),e.jsx(ts,{track:s,onShare:k})]}),e.jsx(V,{children:b&&e.jsx(h.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.3},className:"overflow-hidden",children:e.jsx("div",{className:"mt-6 pt-6 border-t border-border/50",children:e.jsx(ke,{trackId:s.id})})})})]})]})}function z({icon:s,label:t,isActive:i,onClick:a,variant:l}){return e.jsxs(h.button,{whileTap:{scale:.9},onClick:a,className:R("flex flex-col items-center gap-1 p-3 rounded-xl transition-all",i&&l==="accent"&&"text-accent glow-accent",i&&l==="primary"&&"text-primary glow-primary",i&&l==="muted"&&"text-foreground",!i&&"text-muted-foreground hover:text-foreground"),children:[e.jsx("div",{className:R("p-3 rounded-full transition-all",i&&l==="accent"&&"bg-accent/20",i&&l==="primary"&&"bg-primary/20",i&&l==="muted"&&"bg-muted",!i&&"bg-muted/50 hover:bg-muted"),children:e.jsx(s,{className:R("w-6 h-6",i&&l==="accent"&&"fill-current")})}),e.jsx("span",{className:"text-xs font-medium",children:t})]})}export{As as T};
