import{g as R,u as U,a as I,r as i,j as e,L as P,B as k,i as T}from"./index-iaXL3Fks.js";import{g as O,c as A}from"./useSpotifyConnect-C1_WsRoh.js";import{C as F}from"./circle-check-KeaqFbDh.js";import{C as $}from"./circle-alert-DgDha8hy.js";import"./useMutation-D47Lbz91.js";const z="https://accounts.spotify.com/api/token";function V(){const[r]=R(),a=U(),{user:l}=I(),[d,f]=i.useState("loading"),[b,C]=i.useState(""),m=i.useRef(!1),j=i.useRef(null);return i.useEffect(()=>{async function _(){var g;if(!m.current){m.current=!0;try{console.log("[Spotify Callback] Starting..."),console.log("[Spotify Callback] URL params:",Object.fromEntries(r.entries()));const o=r.get("code"),n=r.get("state"),p=r.get("error"),y=r.get("error_description");if(o){const t=`spotify_code_${o}`;if(j.current=t,localStorage.getItem(t)||sessionStorage.getItem(t)){console.warn("[Spotify Callback] Code already consumed, skipping re-exchange"),f("success"),setTimeout(()=>a("/profile",{replace:!0}),800);return}sessionStorage.setItem(t,"used"),localStorage.setItem(t,"used")}if(p)throw console.error("[Spotify Callback] Spotify error:",p,y),new Error(y||`Spotify authorization failed: ${p}`);if(!o||!n)throw console.error("[Spotify Callback] Missing code or state"),new Error("Missing authorization code or state");const s=O();if(console.log("[Spotify Callback] Stored state:",((g=s==null?void 0:s.state)==null?void 0:g.substring(0,8))+"..."),console.log("[Spotify Callback] Received state:",(n==null?void 0:n.substring(0,8))+"..."),!s||s.state!==n)throw console.error("[Spotify Callback] State mismatch"),new Error("Invalid state parameter. Please try connecting again.");if(!l)throw console.error("[Spotify Callback] No user logged in"),new Error("You must be logged in to connect Spotify");console.log("[Spotify Callback] Exchanging code for tokens...");const v="b1d936a5b2bd4cb199d3ede9a4fa2449",u="/clademusic/",L=u.endsWith("/")?u:`${u}/`,x="https://kaospan.github.io/clademusic/spotify-callback";console.log("[Spotify Callback] Using redirect URI:",x);const h=await fetch(z,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",code:o,redirect_uri:x,client_id:v,code_verifier:s.codeVerifier})});if(!h.ok){const t=await h.json();throw console.error("[Spotify Callback] Token exchange failed:",t),new Error(t.error_description||`Token exchange failed: ${t.error}`)}console.log("[Spotify Callback] Token exchange successful");try{const t=`${window.location.origin}${window.location.pathname}`;window.history.replaceState({},document.title,t)}catch(t){console.warn("[Spotify Callback] Failed to clean URL",t)}const c=await h.json();console.log("[Spotify Callback] Fetching Spotify profile...");const S=await fetch("https://api.spotify.com/v1/me",{headers:{Authorization:`Bearer ${c.access_token}`}});if(!S.ok)throw new Error("Failed to fetch Spotify profile");const N=await S.json(),E=new Date(Date.now()+c.expires_in*1e3).toISOString(),{error:w}=await T.from("user_providers").upsert({user_id:l.id,provider:"spotify",provider_user_id:N.id,access_token:c.access_token,refresh_token:c.refresh_token,expires_at:E,connected_at:new Date().toISOString()},{onConflict:"user_id,provider"});if(w)throw console.error("Failed to store Spotify connection:",w),new Error("Failed to save Spotify connection");f("success"),setTimeout(()=>{a("/profile",{replace:!0})},2e3)}catch(o){console.error("Spotify callback error:",o),C(o instanceof Error?o.message:"Unknown error"),f("error")}finally{A()}}}_()},[r,l,a]),e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full text-center",children:[d==="loading"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(P,{size:"lg"}),e.jsx("h2",{className:"text-xl font-semibold",children:"Connecting to Spotify..."}),e.jsx("p",{className:"text-muted-foreground",children:"Please wait while we complete the connection"})]}),d==="success"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center mx-auto",children:e.jsx(F,{className:"w-8 h-8 text-green-500"})}),e.jsx("h2",{className:"text-xl font-semibold text-green-500",children:"Spotify Connected!"}),e.jsx("p",{className:"text-muted-foreground",children:"Redirecting to your profile..."})]}),d==="error"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-destructive/20 flex items-center justify-center mx-auto",children:e.jsx($,{className:"w-8 h-8 text-destructive"})}),e.jsx("h2",{className:"text-xl font-semibold text-destructive",children:"Connection Failed"}),e.jsx("p",{className:"text-muted-foreground",children:b}),e.jsxs("div",{className:"flex gap-2 justify-center mt-4",children:[e.jsx(k,{variant:"outline",onClick:()=>a("/profile"),children:"Go to Profile"}),e.jsx(k,{onClick:()=>a("/profile"),children:"Try Again"})]})]})]})})}export{V as default};
