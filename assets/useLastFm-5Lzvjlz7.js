import{a as c,k as d,p,q as y}from"./index-D1fyLDfA.js";const F="https://ws.audioscrobbler.com/2.0";function k(t){const e=t.trim();if(!e)return"";const r=e.startsWith("@")?e.slice(1):e,s=r.match(/last\.fm\/user\/([^/?#]+)/i);if(s!=null&&s[1])try{return decodeURIComponent(s[1])}catch{return s[1]}const a=r.match(/\/user\/([^/?#]+)/i);if(a!=null&&a[1])try{return decodeURIComponent(a[1])}catch{return a[1]}if(r.includes("last.fm"))try{const i=new URL(/^https?:\/\//i.test(r)?r:`https://${r}`).pathname.split("/").filter(Boolean),n=i.findIndex(m=>m.toLowerCase()==="user"),u=n>=0?i[n+1]:void 0;if(u)return decodeURIComponent(u)}catch{}return r.replace(/\/+$/,"")}function v(){throw new Error("Last.fm API key not configured. Add VITE_LASTFM_API_KEY to your .env file.")}async function l(t,e){try{const r=v(),s=new URLSearchParams({method:t,api_key:r,format:"json",...e}),a=await fetch(`${F}?${s}`);if(!a.ok)return console.error(`Last.fm API error: ${a.status}`),null;const o=await a.json();return o.error?(console.error(`Last.fm error ${o.error}: ${o.message}`),null):o}catch(r){return console.error("Last.fm request failed:",r),null}}async function w(t){const e=await l("user.getInfo",{user:t});return(e==null?void 0:e.user)??null}async function I(t,e="3month",r=10){var a;const s=await l("user.getTopArtists",{user:t,period:e,limit:r.toString()});return((a=s==null?void 0:s.topartists)==null?void 0:a.artist)??[]}async function b(t,e="3month",r=10){var a;const s=await l("user.getTopTracks",{user:t,period:e,limit:r.toString()});return((a=s==null?void 0:s.toptracks)==null?void 0:a.track)??[]}async function g(t,e=20){var s;const r=await l("user.getRecentTracks",{user:t,limit:e.toString()});return((s=r==null?void 0:r.recenttracks)==null?void 0:s.track)??[]}async function q(t){var r,s;const e=await l("user.getWeeklyArtistChart",{user:t});return((s=(r=e==null?void 0:e.weeklyartistchart)==null?void 0:r.artist)==null?void 0:s.length)??0}async function A(t){if(!t)return null;try{const[e,r,s,a,o]=await Promise.all([w(t),I(t,"3month",10),b(t,"3month",10),g(t,10),q(t)]);if(!e)return null;const i=n=>{var m;if(!n||n.length===0)return;const u=["extralarge","large","medium","small"];for(const _ of u){const f=n.find(L=>L.size===_);if(f!=null&&f["#text"])return f["#text"]}return((m=n[0])==null?void 0:m["#text"])||void 0};return{totalScrobbles:parseInt(e.playcount,10)||0,artistCount:parseInt(e.artist_count,10)||0,trackCount:parseInt(e.track_count,10)||0,registeredDate:new Date(parseInt(e.registered.unixtime,10)*1e3),topArtists:r.map(n=>({name:n.name,playcount:parseInt(n.playcount,10)||0,imageUrl:i(n.image)})),topTracks:s.map(n=>({name:n.name,artist:n.artist.name,playcount:parseInt(n.playcount||"0",10)})),recentTracks:a.map(n=>{var u;return{name:n.name,artist:n.artist.name,album:(u=n.album)==null?void 0:u["#text"],playedAt:n.date?new Date(parseInt(n.date.uts,10)*1e3):void 0,imageUrl:i(n.image),nowPlaying:!n.date}}),weeklyArtistCount:o}}catch(e){return console.error("Error fetching Last.fm stats:",e),null}}async function T(t,e){const r=k(e);if(!r)throw new Error("Please enter your Last.fm username");if(!await w(r))throw new Error("Last.fm username not found. Please check the username and try again.");const a=async()=>{const{data:i,error:n}=await supabase.auth.updateUser({data:{lastfm_username:r}});if(n||!(i!=null&&i.user))throw new Error("Failed to save Last.fm connection")},{error:o}=await supabase.from("user_providers").upsert({user_id:t,provider:"lastfm",provider_user_id:r,access_token:"public",refresh_token:"public",expires_at:new Date(Date.now()+365*24*60*60*1e3).toISOString(),connected_at:new Date().toISOString()},{onConflict:"user_id,provider"});if(o){console.error("Failed to store Last.fm connection (user_providers):",o),await a();return}}async function S(t){var o,i;const{data:e,error:r}=await supabase.from("user_providers").select("provider_user_id").eq("user_id",t).eq("provider","lastfm").maybeSingle();if(!r&&(e!=null&&e.provider_user_id))return e.provider_user_id;const{data:s}=await supabase.auth.getUser(),a=(o=s==null?void 0:s.user)==null?void 0:o.user_metadata;return((i=s==null?void 0:s.user)==null?void 0:i.id)===t&&(a!=null&&a.lastfm_username)?a.lastfm_username:null}async function C(t){const{error:e}=await supabase.from("user_providers").delete().eq("user_id",t).eq("provider","lastfm");e&&console.warn("Failed to remove Last.fm from user_providers:",e);const{error:r}=await supabase.auth.updateUser({data:{lastfm_username:null}});if(r)throw new Error("Failed to disconnect Last.fm")}function h(){const{user:t}=c();return d({queryKey:["lastfm-username",t==null?void 0:t.id],queryFn:()=>S(t.id),enabled:!!t,staleTime:5*60*1e3})}function E(){const{user:t}=c(),{data:e}=h();return d({queryKey:["lastfm-stats",e],queryFn:()=>e?A(e):null,enabled:!!t&&!!e,staleTime:5*60*1e3,refetchOnWindowFocus:!0})}function P(t=200){const{user:e}=c(),{data:r}=h();return d({queryKey:["lastfm-recent",r,t],queryFn:()=>r?g(r,t):[],enabled:!!e&&!!r,staleTime:2*60*1e3,refetchOnWindowFocus:!0})}function x(){const{user:t}=c(),e=p();return y({mutationFn:async r=>{if(!t)throw new Error("Must be logged in");return await T(t.id,r),r},onSuccess:r=>{e.setQueryData(["lastfm-username",t==null?void 0:t.id],r),e.invalidateQueries({queryKey:["lastfm-stats"]}),e.invalidateQueries({queryKey:["user-providers"]})}})}function K(){const{user:t}=c(),e=p();return y({mutationFn:async()=>{if(!t)throw new Error("Must be logged in");await C(t.id)},onSuccess:()=>{e.setQueryData(["lastfm-username",t==null?void 0:t.id],null),e.setQueryData(["lastfm-stats",null],null),e.invalidateQueries({queryKey:["user-providers"]})}})}export{h as a,E as b,x as c,K as d,k as n,P as u};
